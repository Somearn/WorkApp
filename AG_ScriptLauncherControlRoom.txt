$ErrorActionPreference = 'Stop'

Add-Type -AssemblyName System.Windows.Forms | Out-Null
Add-Type -AssemblyName System.Drawing       | Out-Null

# AG_ScriptLauncherControlRoom.txt
# Embedded page module for SomearnTK (WinForms control returned to MenuMain)
# Guardrails:
# - No timers, jobs, background loops, or auto-refresh network calls
# - Loads scripts only on Refresh button (manual action)
# - Runs TXT scripts in-process (current user context) on Run button
# - Returns ONE WinForms Control (Panel) so HostPanel can Dock=Fill safely

function Get-AG_ScriptLauncherPage {
    [CmdletBinding()]
    param(
        # Status callback from MenuMain. Accepts ScriptBlock, Delegate, or Label/ToolStripStatusLabel.
        [Parameter()] $SetStatus,

        # Folder containing .txt scripts to list. MenuMain passes -ScriptsPath.
        [Parameter()]
        [Alias('Path','Folder','Root')]
        [string] $ScriptsPath
    )

    function Set-StatusSafe([string]$Text) {
        try {
            if (-not $SetStatus) { return }

            if ($SetStatus -is [scriptblock]) {
                & $SetStatus $Text
                return
            }

            if ($SetStatus -is [System.Delegate]) {
                $SetStatus.DynamicInvoke(@($Text)) | Out-Null
                return
            }

            if ($SetStatus -is [System.Windows.Forms.ToolStripStatusLabel] -or
                $SetStatus -is [System.Windows.Forms.Label]) {
                $SetStatus.Text = $Text
                return
            }
        } catch {
            # Never throw from status updates
        }
    }

    function MsgErr([string]$t){ [System.Windows.Forms.MessageBox]::Show($t,'SomearnTK','OK','Error') | Out-Null }
    function MsgWarn([string]$t){ [System.Windows.Forms.MessageBox]::Show($t,'SomearnTK','OK','Warning') | Out-Null }

    # Resolve scripts folder
    if ([string]::IsNullOrWhiteSpace($ScriptsPath)) {
        if ($script:AgScriptsFolder -and -not [string]::IsNullOrWhiteSpace($script:AgScriptsFolder)) {
            $ScriptsPath = $script:AgScriptsFolder
        } else {
            $ScriptsPath = (Join-Path $env:USERPROFILE 'Downloads')
        }
    }

    # --- UI: PageRoot -> TableLayoutPanel (Header / Filters / Content) ---
    $pageRoot = New-Object System.Windows.Forms.Panel
    $pageRoot.BackColor = [System.Drawing.Color]::FromArgb(10,10,10)
    $pageRoot.Dock = 'Fill'
    $pageRoot.Padding = '10,10,10,10'

    $tlp = New-Object System.Windows.Forms.TableLayoutPanel
    $tlp.Dock = 'Fill'
    $tlp.BackColor = [System.Drawing.Color]::FromArgb(10,10,10)
    $tlp.ColumnCount = 1
    $tlp.RowCount = 3
    $tlp.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute, 56))) | Out-Null
    $tlp.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute, 52))) | Out-Null
    $tlp.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Percent, 100))) | Out-Null
    [void]$pageRoot.Controls.Add($tlp)

    # Header row
    $hdr = New-Object System.Windows.Forms.Panel
    $hdr.Dock = 'Fill'
    $hdr.BackColor = [System.Drawing.Color]::FromArgb(18,18,22)
    $hdr.Padding = '12,10,12,10'

    $hdrTlp = New-Object System.Windows.Forms.TableLayoutPanel
    $hdrTlp.Dock = 'Fill'
    $hdrTlp.BackColor = $hdr.BackColor
    $hdrTlp.ColumnCount = 2
    $hdrTlp.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent, 70))) | Out-Null
    $hdrTlp.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent, 30))) | Out-Null
    [void]$hdr.Controls.Add($hdrTlp)

    $lblTitle = New-Object System.Windows.Forms.Label
    $lblTitle.Text = 'Script Launcher'
    $lblTitle.ForeColor = 'Gainsboro'
    $lblTitle.Font = New-Object System.Drawing.Font('Segoe UI', 16, [System.Drawing.FontStyle]::Bold)
    $lblTitle.Dock = 'Fill'
    $lblTitle.TextAlign = 'MiddleLeft'
    [void]$hdrTlp.Controls.Add($lblTitle,0,0)

    $btnPanel = New-Object System.Windows.Forms.FlowLayoutPanel
    $btnPanel.Dock = 'Fill'
    $btnPanel.FlowDirection = 'RightToLeft'
    $btnPanel.WrapContents = $false
    $btnPanel.BackColor = $hdr.BackColor
    [void]$hdrTlp.Controls.Add($btnPanel,1,0)

    function New-TopButton([string]$text) {
        $b = New-Object System.Windows.Forms.Button
        $b.Text = $text
        $b.Width = 120
        $b.Height = 34
        $b.FlatStyle = 'Flat'
        $b.FlatAppearance.BorderSize = 1
        $b.FlatAppearance.BorderColor = [System.Drawing.Color]::FromArgb(130,140,255)
        $b.BackColor = [System.Drawing.Color]::FromArgb(85,95,235)
        $b.ForeColor = 'White'
        $b.Font = New-Object System.Drawing.Font('Segoe UI',9.5,[System.Drawing.FontStyle]::Bold)
        $b.Margin = '6,2,0,2'
        return $b
    }

    $btnRun = New-TopButton 'Run'
    $btnRefresh = New-TopButton 'Refresh'
    $btnOpenFolder = New-TopButton 'Open Folder'

    [void]$btnPanel.Controls.Add($btnRun)
    [void]$btnPanel.Controls.Add($btnRefresh)
    [void]$btnPanel.Controls.Add($btnOpenFolder)

    $tlp.Controls.Add($hdr,0,0) | Out-Null

    # Filters row (path + hint)
    $flt = New-Object System.Windows.Forms.Panel
    $flt.Dock = 'Fill'
    $flt.BackColor = [System.Drawing.Color]::FromArgb(12,12,14)
    $flt.Padding = '12,10,12,10'

    $fltTlp = New-Object System.Windows.Forms.TableLayoutPanel
    $fltTlp.Dock = 'Fill'
    $fltTlp.BackColor = $flt.BackColor
    $fltTlp.ColumnCount = 2
    $fltTlp.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent, 70))) | Out-Null
    $fltTlp.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent, 30))) | Out-Null
    [void]$flt.Controls.Add($fltTlp)

    $txtPath = New-Object System.Windows.Forms.TextBox
    $txtPath.Dock = 'Fill'
    $txtPath.ReadOnly = $true
    $txtPath.Text = $ScriptsPath
    $txtPath.BackColor = [System.Drawing.Color]::FromArgb(18,18,22)
    $txtPath.ForeColor = 'Gainsboro'
    $txtPath.BorderStyle = 'FixedSingle'
    $txtPath.Font = New-Object System.Drawing.Font('Consolas',10)
    [void]$fltTlp.Controls.Add($txtPath,0,0)

    $lblHint = New-Object System.Windows.Forms.Label
    $lblHint.Dock = 'Fill'
    $lblHint.Text = 'Manual-only: click Refresh to load scripts.'
    $lblHint.ForeColor = [System.Drawing.Color]::FromArgb(150,150,160)
    $lblHint.Font = New-Object System.Drawing.Font('Segoe UI',9,[System.Drawing.FontStyle]::Italic)
    $lblHint.TextAlign = 'MiddleRight'
    [void]$fltTlp.Controls.Add($lblHint,1,0)

    $tlp.Controls.Add($flt,0,1) | Out-Null

    # Content row (left list, right output)
    $content = New-Object System.Windows.Forms.TableLayoutPanel
    $content.Dock = 'Fill'
    $content.BackColor = [System.Drawing.Color]::FromArgb(10,10,10)
    $content.ColumnCount = 2
    $content.RowCount = 1
    $content.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent, 42))) | Out-Null
    $content.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent, 58))) | Out-Null

    # Left: list
    $leftCard = New-Object System.Windows.Forms.Panel
    $leftCard.Dock = 'Fill'
    $leftCard.BackColor = [System.Drawing.Color]::FromArgb(18,18,22)
    $leftCard.Padding = '10,10,10,10'

    $lv = New-Object System.Windows.Forms.ListView
    $lv.Dock = 'Fill'
    $lv.View = 'Details'
    $lv.FullRowSelect = $true
    $lv.HideSelection = $false
    $lv.MultiSelect = $false
    $lv.BackColor = [System.Drawing.Color]::FromArgb(10,10,10)
    $lv.ForeColor = 'Gainsboro'
    $lv.BorderStyle = 'FixedSingle'
    $lv.Font = New-Object System.Drawing.Font('Segoe UI',9)

    [void]$lv.Columns.Add('Script', 280)
    [void]$lv.Columns.Add('Modified', 140)

    [void]$leftCard.Controls.Add($lv)
    $content.Controls.Add($leftCard,0,0) | Out-Null

    # Right: output
    $rightCard = New-Object System.Windows.Forms.Panel
    $rightCard.Dock = 'Fill'
    $rightCard.BackColor = [System.Drawing.Color]::FromArgb(18,18,22)
    $rightCard.Padding = '10,10,10,10'

    $out = New-Object System.Windows.Forms.TextBox
    $out.Dock = 'Fill'
    $out.Multiline = $true
    $out.ScrollBars = 'Both'
    $out.ReadOnly = $true
    $out.WordWrap = $false
    $out.BackColor = [System.Drawing.Color]::FromArgb(10,10,10)
    $out.ForeColor = 'Gainsboro'
    $out.BorderStyle = 'FixedSingle'
    $out.Font = New-Object System.Drawing.Font('Consolas',10)
    [void]$rightCard.Controls.Add($out)

    $content.Controls.Add($rightCard,1,0) | Out-Null
    $tlp.Controls.Add($content,0,2) | Out-Null

    function Write-Out([string]$msg) {
        try {
            $ts = (Get-Date).ToString('HH:mm:ss')
            $out.AppendText("[$ts] $msg`r`n")
        } catch {}
    }

    function Load-Scripts {
        try {
            $lv.Items.Clear()

            if (-not (Test-Path -LiteralPath $ScriptsPath)) {
                Write-Out "Folder not found: $ScriptsPath"
                Set-StatusSafe "Script Launcher: folder not found"
                return
            }

            $files = Get-ChildItem -LiteralPath $ScriptsPath -Filter '*.txt' -File -ErrorAction Stop |
                     Sort-Object -Property LastWriteTime -Descending

            foreach ($f in $files) {
                $item = New-Object System.Windows.Forms.ListViewItem($f.Name)
                [void]$item.SubItems.Add($f.LastWriteTime.ToString('yyyy-MM-dd HH:mm'))
                $item.Tag = $f.FullName
                [void]$lv.Items.Add($item)
            }

            Write-Out ("Loaded {0} script(s) from: {1}" -f $files.Count, $ScriptsPath)
            Set-StatusSafe ("Script Launcher ready (Refresh to load). {0} scripts." -f $files.Count)
        } catch {
            Write-Out ("Load failed: {0}" -f $_.Exception.Message)
            Set-StatusSafe "Script Launcher: load failed"
            MsgErr $_.Exception.Message
        }
    }

    function Get-SelectedPath {
        if (-not $lv.SelectedItems -or $lv.SelectedItems.Count -lt 1) { return $null }
        return [string]$lv.SelectedItems[0].Tag
    }

    function Run-Selected {
        $p = Get-SelectedPath
        if ([string]::IsNullOrWhiteSpace($p)) {
            MsgWarn "Select a script first."
            return
        }

        if (-not (Test-Path -LiteralPath $p)) {
            MsgErr "File not found: $p"
            return
        }

        # SECURITY FIX: Validate file is actually in allowed scripts folder
        try {
            $resolvedPath = (Resolve-Path -LiteralPath $p).Path
            $resolvedScripts = (Resolve-Path -LiteralPath $ScriptsPath).Path
            if (-not $resolvedPath.StartsWith($resolvedScripts, [StringComparison]::OrdinalIgnoreCase)) {
                MsgErr "Security violation: Script must be in authorized scripts folder."
                return
            }
        } catch {
            MsgErr "Failed to validate script path: $($_.Exception.Message)"
            return
        }

        try {
            $name = [System.IO.Path]::GetFileName($p)
            Write-Out "----------------------------------------"
            Write-Out ("Running: {0}" -f $name)
            Set-StatusSafe ("Running: {0}" -f $name)

            # SECURITY FIX: Use direct dot-sourcing instead of ScriptBlock::Create
            # This avoids EDR flagging for string-to-execution patterns
            . $p 2>&1 | ForEach-Object {
                $line = $_.ToString()
                if ($line -ne '') { Write-Out $line }
            }

            Write-Out ("Done: {0}" -f $name)
            Set-StatusSafe ("Done: {0}" -f $name)
        } catch {
            Write-Out ("Run failed: {0}" -f $_.Exception.Message)
            Set-StatusSafe "Script Launcher: run failed"
            MsgErr $_.Exception.Message
        }
    }

    # Events
    $btnRefresh.Add_Click({ Load-Scripts }) | Out-Null
    $btnRun.Add_Click({ Run-Selected }) | Out-Null
    $btnOpenFolder.Add_Click({
        try {
            if (Test-Path -LiteralPath $ScriptsPath) {
                Start-Process -FilePath 'explorer.exe' -ArgumentList @($ScriptsPath) | Out-Null
            } else {
                MsgErr "Folder not found: $ScriptsPath"
            }
        } catch {
            MsgErr $_.Exception.Message
        }
    }) | Out-Null

    $lv.Add_DoubleClick({ Run-Selected }) | Out-Null

    # Initial status (manual refresh)
    Write-Out "Script Launcher ready. Click Refresh to load scripts."
    Set-StatusSafe "Script Launcher ready (Refresh to load)."

    return $pageRoot
}
