# AG_SiteManager.txt
# SomearnTK - Site Manager (Read-only viewer, low-noise)
#
# Change in this revision:
# - Left list shows Street Address ONLY (no fallbacks). Rows without Street Address are excluded from list.
#
# Constraints honored:
# - PowerShell 5.1, TXT-only execution
# - No local file writes (reads CSV only; Update button opens CSV in external editor)
# - No background jobs, timers, polling, or indefinite loops
# - Auto-load runs ONCE on page open (CSV read once)
#
# UI behavior:
# - Left list shows Street Address only
# - Clicking a site populates details on right
# - Filters as you type (local only; no extra CSV reads)
# - Bottom buttons:
#     Update SiteInformation  -> opens CSV in default editor (you save there)
#     Refresh SiteInformation -> reloads CSV on demand (manual)

$ErrorActionPreference = 'Stop'

Add-Type -AssemblyName System.Windows.Forms | Out-Null
Add-Type -AssemblyName System.Drawing       | Out-Null

function Show-SiteInventoryView {
    [CmdletBinding()]
    param(
        [Parameter()][System.Windows.Forms.Control]$HostPanel,
        [Parameter()][System.Windows.Forms.Control]$Parent,
        [Parameter()][System.Windows.Forms.Control]$MainPanel,
        [Parameter()][string]$DataPath
    )

    $target = $HostPanel
    if (-not $target) { $target = $Parent }
    if (-not $target) { $target = $MainPanel }

    if (-not $target) {
        [System.Windows.Forms.MessageBox]::Show("No host panel provided to embed the Site Manager view.","SomearnTK","OK","Error") | Out-Null
        return
    }

    $setStatus = {
        param([string]$t)
        try { if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = $t } } catch {}
    }

    try {
        $target.SuspendLayout()
        $target.Controls.Clear()

        $page = Get-AG_SiteManagerPage -SetStatus $setStatus -DataPath $DataPath
        $page.Dock = 'Fill'
        [void]$target.Controls.Add($page)

    } catch {
        [System.Windows.Forms.MessageBox]::Show($_.Exception.Message,'SomearnTK','OK','Error') | Out-Null
    } finally {
        try { $target.ResumeLayout() } catch {}
    }
}

function Show-SiteManagerView {
    [CmdletBinding()]
    param(
        [Parameter()][System.Windows.Forms.Control]$HostPanel,
        [Parameter()][System.Windows.Forms.Control]$Parent,
        [Parameter()][System.Windows.Forms.Control]$MainPanel,
        [Parameter()][string]$DataPath
    )
    Show-SiteInventoryView -HostPanel $HostPanel -Parent $Parent -MainPanel $MainPanel -DataPath $DataPath
}

function Get-AG_SiteManagerPage {
    [CmdletBinding()]
    param(
        [Parameter()][ScriptBlock]$SetStatus,
        [Parameter()][string]$DataPath
    )

    function _MsgErr([string]$t)  { [System.Windows.Forms.MessageBox]::Show($t,'SomearnTK','OK','Error') | Out-Null }

    $script:SM_SetStatus = $SetStatus
    $script:SM_Status = {
        param([string]$t)
        if ($script:SM_SetStatus) {
            try { & $script:SM_SetStatus $t } catch {}
        }
    }

    function Resolve-DefaultSiteInfoPath {
        param([string]$explicit)

        if ($explicit -and -not [string]::IsNullOrWhiteSpace($explicit)) { return $explicit }

        if ($script:AgDataFolder -and (Test-Path -LiteralPath $script:AgDataFolder)) {
            return (Join-Path $script:AgDataFolder 'SiteInformation.csv')
        }

        if ($script:AgRoot -and (Test-Path -LiteralPath $script:AgRoot)) {
            return (Join-Path $script:AgRoot 'appdata\\SiteInformation.csv')
        }

        if ($script:AG_LaunchPath) {
            $root = Split-Path -LiteralPath $script:AG_LaunchPath -Parent
            return (Join-Path $root 'appdata\\SiteInformation.csv')
        }

        return 'SiteInformation.csv'
    }

    $DataPath = Resolve-DefaultSiteInfoPath -explicit $DataPath

    function Resolve-SMDataPath([string]$p) {
        try {
            if (Test-Path -LiteralPath $p) { return $p }

            $folder = Split-Path -LiteralPath $p -Parent
            if (-not $folder -or -not (Test-Path -LiteralPath $folder)) { return $p }

            $candidates = @(
                (Join-Path $folder 'SiteInformation.csv'),
                (Join-Path $folder 'SiteInformationDirectory.csv'),
                (Join-Path $folder 'SiteInfo.csv')
            )
            foreach ($c in $candidates) { if (Test-Path -LiteralPath $c) { return $c } }

            $match = Get-ChildItem -LiteralPath $folder -Filter 'SiteInformation*.csv' -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($match) { return $match.FullName }

        } catch { }
        return $p
    }

    $script:SM_ResolvedDataPath = Resolve-SMDataPath $DataPath

    $script:SM_Theme = @{
        Form      = [System.Drawing.Color]::FromArgb(12, 14, 24)
        Panel     = [System.Drawing.Color]::FromArgb(18, 20, 34)
        Card      = [System.Drawing.Color]::FromArgb(24, 26, 46)
        Border    = [System.Drawing.Color]::FromArgb(46, 50, 86)
        Text      = [System.Drawing.Color]::FromArgb(230, 232, 246)
        Muted     = [System.Drawing.Color]::FromArgb(160, 165, 198)
        Accent    = [System.Drawing.Color]::FromArgb(160, 90, 255)
        Btn2      = [System.Drawing.Color]::FromArgb(40, 42, 75)
    }

    $fontTitle  = New-Object System.Drawing.Font('Segoe UI', 16, [System.Drawing.FontStyle]::Bold)
    $fontBody   = New-Object System.Drawing.Font('Segoe UI', 10, [System.Drawing.FontStyle]::Regular)
    $fontSmall  = New-Object System.Drawing.Font('Segoe UI', 9,  [System.Drawing.FontStyle]::Regular)
    $fontMono   = New-Object System.Drawing.Font('Consolas', 10, [System.Drawing.FontStyle]::Regular)

    function New-CardPanel { param([int]$Pad=12)
        $p = New-Object System.Windows.Forms.Panel
        $p.BackColor = $script:SM_Theme.Card
        $p.Padding = New-Object System.Windows.Forms.Padding($Pad)
        $p.Margin  = '0,0,0,0'
        $p.Dock = 'Fill'
        $p.BorderStyle = 'FixedSingle'
        return $p
    }

    function New-ActionButton {
        param([string]$Text)

        $b = New-Object System.Windows.Forms.Button
        $b.Text = $Text
        $b.Height = 36
        $b.Width  = 240
        $b.FlatStyle = 'Flat'
        $b.FlatAppearance.BorderSize = 1
        $b.FlatAppearance.BorderColor = $script:SM_Theme.Border
        $b.BackColor = $script:SM_Theme.Btn2
        $b.ForeColor = $script:SM_Theme.Text
        $b.Font = New-Object System.Drawing.Font('Segoe UI', 9.5, [System.Drawing.FontStyle]::Bold)
        $b.Margin = '8,0,0,0'
        return $b
    }

    $script:SM_Data = @()
    $script:SM_AutoLoaded = $false
    $script:SM_FilterPending = $false

    $PageRoot = New-Object System.Windows.Forms.Panel
    $PageRoot.Dock = 'Fill'
    $PageRoot.BackColor = $script:SM_Theme.Form

    $TLP = New-Object System.Windows.Forms.TableLayoutPanel
    $TLP.Dock = 'Fill'
    $TLP.BackColor = $script:SM_Theme.Form
    $TLP.ColumnCount = 1
    $TLP.RowCount = 3
    $TLP.Padding = '14,12,14,12'
    $TLP.RowStyles.Clear()
    [void]$TLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute, 56)))
    [void]$TLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::AutoSize)))
    [void]$TLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Percent, 100)))
    [void]$PageRoot.Controls.Add($TLP)

    $Header = New-Object System.Windows.Forms.Panel
    $Header.Dock = 'Fill'
    $Header.BackColor = $script:SM_Theme.Form

    $lblTitle = New-Object System.Windows.Forms.Label
    $lblTitle.Text = 'Site Manager'
    $lblTitle.Font = $fontTitle
    $lblTitle.ForeColor = $script:SM_Theme.Text
    $lblTitle.AutoSize = $true
    $lblTitle.Location = New-Object System.Drawing.Point(0,10)
    [void]$Header.Controls.Add($lblTitle)
    [void]$TLP.Controls.Add($Header, 0, 0)

    $Filters = New-Object System.Windows.Forms.Panel
    $Filters.Dock = 'Top'
    $Filters.BackColor = $script:SM_Theme.Form
    $Filters.Padding = '0,10,0,10'
    $Filters.AutoSize = $true
    $Filters.AutoSizeMode = 'GrowAndShrink'

    $FiltersTLP = New-Object System.Windows.Forms.TableLayoutPanel
    $FiltersTLP.Dock = 'Top'
    $FiltersTLP.BackColor = $script:SM_Theme.Form
    $FiltersTLP.AutoSize = $true
    $FiltersTLP.AutoSizeMode = 'GrowAndShrink'
    $FiltersTLP.ColumnCount = 4
    $FiltersTLP.RowCount = 2
    $FiltersTLP.ColumnStyles.Clear()
    [void]$FiltersTLP.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute, 120)))
    [void]$FiltersTLP.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent, 50)))
    [void]$FiltersTLP.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute, 140)))
    [void]$FiltersTLP.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent, 50)))
    $FiltersTLP.RowStyles.Clear()
    [void]$FiltersTLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::AutoSize)))
    [void]$FiltersTLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::AutoSize)))

    $lblSite = New-Object System.Windows.Forms.Label
    $lblSite.Text = 'Street Search'
    $lblSite.ForeColor = $script:SM_Theme.Muted
    $lblSite.Font = $fontBody
    $lblSite.AutoSize = $true
    $lblSite.Margin = '0,8,0,0'

    $txtSite = New-Object System.Windows.Forms.TextBox
    $txtSite.Font = $fontBody
    $txtSite.BackColor = $script:SM_Theme.Panel
    $txtSite.ForeColor = $script:SM_Theme.Text
    $txtSite.BorderStyle = 'FixedSingle'
    $txtSite.Dock = 'Fill'
    $txtSite.Margin = '0,6,10,0'

    $lblCircuit = New-Object System.Windows.Forms.Label
    $lblCircuit.Text = 'Circuit / ISP'
    $lblCircuit.ForeColor = $script:SM_Theme.Muted
    $lblCircuit.Font = $fontBody
    $lblCircuit.AutoSize = $true
    $lblCircuit.Margin = '0,8,0,0'

    $txtCircuit = New-Object System.Windows.Forms.TextBox
    $txtCircuit.Font = $fontBody
    $txtCircuit.BackColor = $script:SM_Theme.Panel
    $txtCircuit.ForeColor = $script:SM_Theme.Text
    $txtCircuit.BorderStyle = 'FixedSingle'
    $txtCircuit.Dock = 'Fill'
    $txtCircuit.Margin = '0,6,0,0'

    $lblHint = New-Object System.Windows.Forms.Label
    $lblHint.Text = 'Tip: filters as you type (local only).'
    $lblHint.ForeColor = $script:SM_Theme.Muted
    $lblHint.Font = $fontSmall
    $lblHint.AutoSize = $true
    $lblHint.Margin = '0,8,0,0'

    $lblCount = New-Object System.Windows.Forms.Label
    $lblCount.Text = '0 sites'
    $lblCount.ForeColor = $script:SM_Theme.Accent
    $lblCount.Font = $fontSmall
    $lblCount.AutoSize = $true
    $lblCount.Margin = '0,8,0,0'
    $lblCount.TextAlign = 'MiddleRight'
    $lblCount.Dock = 'Right'

    [void]$FiltersTLP.Controls.Add($lblSite, 0, 0)
    [void]$FiltersTLP.Controls.Add($txtSite, 1, 0)
    [void]$FiltersTLP.Controls.Add($lblCircuit, 2, 0)
    [void]$FiltersTLP.Controls.Add($txtCircuit, 3, 0)
    [void]$FiltersTLP.Controls.Add($lblHint, 0, 1)
    $FiltersTLP.SetColumnSpan($lblHint, 3)
    [void]$FiltersTLP.Controls.Add($lblCount, 3, 1)

    [void]$Filters.Controls.Add($FiltersTLP)
    [void]$TLP.Controls.Add($Filters, 0, 1)

    $ContentHost = New-Object System.Windows.Forms.Panel
    $ContentHost.Dock = 'Fill'
    $ContentHost.BackColor = $script:SM_Theme.Form

    $ContentOuter = New-Object System.Windows.Forms.TableLayoutPanel
    $ContentOuter.Dock = 'Fill'
    $ContentOuter.BackColor = $script:SM_Theme.Form
    $ContentOuter.ColumnCount = 1
    $ContentOuter.RowCount = 2
    $ContentOuter.RowStyles.Clear()
    [void]$ContentOuter.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Percent, 100)))
    [void]$ContentOuter.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute, 52)))
    [void]$ContentHost.Controls.Add($ContentOuter)

    $ContentTLP = New-Object System.Windows.Forms.TableLayoutPanel
    $ContentTLP.Dock = 'Fill'
    $ContentTLP.BackColor = $script:SM_Theme.Form
    $ContentTLP.ColumnCount = 2
    $ContentTLP.RowCount = 1
    $ContentTLP.ColumnStyles.Clear()
    [void]$ContentTLP.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute, 520)))
    [void]$ContentTLP.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent, 100)))

    $LeftCard = New-CardPanel -Pad 12
    $lbSites = New-Object System.Windows.Forms.ListBox
    $lbSites.Dock = 'Fill'
    $lbSites.Font = $fontBody
    $lbSites.BackColor = $script:SM_Theme.Panel
    $lbSites.ForeColor = $script:SM_Theme.Text
    $lbSites.BorderStyle = 'FixedSingle'
    $lbSites.IntegralHeight = $false
    [void]$LeftCard.Controls.Add($lbSites)

    $RightCard = New-CardPanel -Pad 14
    $RightTLP = New-Object System.Windows.Forms.TableLayoutPanel
    $RightTLP.Dock = 'Fill'
    $RightTLP.BackColor = $script:SM_Theme.Card
    $RightTLP.ColumnCount = 1
    $RightTLP.RowCount = 3
    $RightTLP.RowStyles.Clear()
    [void]$RightTLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute, 34)))
    [void]$RightTLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::AutoSize)))
    [void]$RightTLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Percent, 100)))
    [void]$RightCard.Controls.Add($RightTLP)

    $lblDetailHdr = New-Object System.Windows.Forms.Label
    $lblDetailHdr.Text = 'Site Details'
    $lblDetailHdr.Font = New-Object System.Drawing.Font('Segoe UI', 12, [System.Drawing.FontStyle]::Bold)
    $lblDetailHdr.ForeColor = $script:SM_Theme.Text
    $lblDetailHdr.AutoSize = $true
    $lblDetailHdr.Margin = '0,0,0,8'

    $lblSelected = New-Object System.Windows.Forms.Label
    $lblSelected.Text = 'Select a street address on the left.'
    $lblSelected.Font = $fontBody
    $lblSelected.ForeColor = $script:SM_Theme.Muted
    $lblSelected.AutoSize = $true
    $lblSelected.Margin = '0,0,0,10'

    $rtbDetails = New-Object System.Windows.Forms.RichTextBox
    $rtbDetails.Dock = 'Fill'
    $rtbDetails.ReadOnly = $true
    $rtbDetails.BorderStyle = 'FixedSingle'
    $rtbDetails.BackColor = $script:SM_Theme.Panel
    $rtbDetails.ForeColor = $script:SM_Theme.Text
    $rtbDetails.Font = $fontMono
    $rtbDetails.DetectUrls = $true
    $rtbDetails.WordWrap = $false

    [void]$RightTLP.Controls.Add($lblDetailHdr, 0, 0)
    [void]$RightTLP.Controls.Add($lblSelected, 0, 1)
    [void]$RightTLP.Controls.Add($rtbDetails, 0, 2)

    [void]$ContentTLP.Controls.Add($LeftCard, 0, 0)
    [void]$ContentTLP.Controls.Add($RightCard, 1, 0)

    [void]$ContentOuter.Controls.Add($ContentTLP, 0, 0)

    $ActionBar = New-Object System.Windows.Forms.Panel
    $ActionBar.Dock = 'Fill'
    $ActionBar.BackColor = $script:SM_Theme.Form
    $ActionBar.Padding = '0,8,0,0'

    $ActionFlow = New-Object System.Windows.Forms.FlowLayoutPanel
    $ActionFlow.Dock = 'Right'
    $ActionFlow.FlowDirection = 'RightToLeft'
    $ActionFlow.WrapContents = $false
    $ActionFlow.AutoSize = $true
    $ActionFlow.BackColor = $script:SM_Theme.Form

    $btnRefresh = New-ActionButton -Text 'Refresh SiteInformation'
    $btnUpdate  = New-ActionButton -Text 'Update SiteInformation'

    [void]$ActionFlow.Controls.Add($btnRefresh)
    [void]$ActionFlow.Controls.Add($btnUpdate)

    [void]$ActionBar.Controls.Add($ActionFlow)
    [void]$ContentOuter.Controls.Add($ActionBar, 0, 1)

    [void]$TLP.Controls.Add($ContentHost, 0, 2)

    [void]$TLP.Controls.Add($ContentHost, 0, 2)

    $script:SM_UI = @{
        LbSites     = $lbSites
        TxtSite     = $txtSite
        TxtCircuit  = $txtCircuit
        LblCount    = $lblCount
        LblSelected = $lblSelected
        RtbDetails  = $rtbDetails
        PageRoot    = $PageRoot
        BtnRefresh  = $btnRefresh
        BtnUpdate   = $btnUpdate
    }

    $script:SM_GetFieldValue = {
        param($obj, [string[]]$names)
        foreach ($n in $names) {
            if ($obj.PSObject.Properties.Name -contains $n) {
                $v = $obj.$n
                if ($null -ne $v -and -not [string]::IsNullOrWhiteSpace([string]$v)) { return [string]$v }
            }
        }
        return ''
    }

    $script:SM_NormalizeRow = {
        param($row)

        $street    = & $script:SM_GetFieldValue $row @('Street Address','StreetAddress','Address','Street')
        $city      = & $script:SM_GetFieldValue $row @('City','Town')
        $circuit   = & $script:SM_GetFieldValue $row @('Circuit ID','CircuitID','Circuit')
        $service   = & $script:SM_GetFieldValue $row @('Service ID','ServiceID','Service')
        $acct      = & $script:SM_GetFieldValue $row @('Acct #','Account','AccountNumber','Acct')
        $isp       = & $script:SM_GetFieldValue $row @('ISP Provider','ISP','Provider')
        $ispb      = & $script:SM_GetFieldValue $row @('ISP Provider Backup','ISP Backup','Backup ISP','ISPProviderBackup')
        $affiliate = & $script:SM_GetFieldValue $row @('Affiliate','Site','Site Name','Location')
        $comments  = & $script:SM_GetFieldValue $row @('Comments','Notes')
        $phone     = & $script:SM_GetFieldValue $row @('Telephone','Phone','Phone Number')
        $hours     = & $script:SM_GetFieldValue $row @('Hours of Operation','Hours','HoursOfOperation')

        # LEFT LIST LABEL IS STREET ADDRESS ONLY (NO FALLBACKS)
        $label = $street

        [pscustomobject]@{
            Label         = $label
            Affiliate     = $affiliate
            StreetAddress = $street
            City          = $city
            CircuitID     = $circuit
            ServiceID     = $service
            Account       = $acct
            ISPProvider   = $isp
            ISPBackup     = $ispb
            Comments      = $comments
            Telephone     = $phone
            Hours         = $hours
            Raw           = $row
        }
    }

    $script:SM_RenderDetailsByLabel = {
        param([string]$label)

        if (-not $script:SM_Data -or $script:SM_Data.Count -eq 0) { return }
        $match = $script:SM_Data | Where-Object { $_.Label -eq $label } | Select-Object -First 1
        if (-not $match) { return }

        $lines = New-Object System.Collections.Generic.List[string]
        [void]$lines.Add(("Street Address      : {0}" -f $match.StreetAddress))
        if ($match.City)          { [void]$lines.Add(("City                 : {0}" -f $match.City)) }
        if ($match.Affiliate)     { [void]$lines.Add(("Affiliate            : {0}" -f $match.Affiliate)) }

        if ($match.CircuitID)     { [void]$lines.Add(("Circuit ID           : {0}" -f $match.CircuitID)) }
        if ($match.ServiceID)     { [void]$lines.Add(("Service ID           : {0}" -f $match.ServiceID)) }
        if ($match.Account)       { [void]$lines.Add(("Acct #               : {0}" -f $match.Account)) }

        if ($match.ISPProvider)   { [void]$lines.Add(("ISP Provider         : {0}" -f $match.ISPProvider)) }
        if ($match.ISPBackup)     { [void]$lines.Add(("ISP Provider Backup  : {0}" -f $match.ISPBackup)) }

        if ($match.Telephone)     { [void]$lines.Add(("Telephone            : {0}" -f $match.Telephone)) }
        if ($match.Hours)         { [void]$lines.Add(("Hours of Operation   : {0}" -f $match.Hours)) }

        [void]$lines.Add('')
        if ($match.Comments) { [void]$lines.Add('Comments:'); [void]$lines.Add($match.Comments) }
        else { [void]$lines.Add('Comments: (none)') }

        $script:SM_UI.LblSelected.Text = $match.StreetAddress
        $script:SM_UI.RtbDetails.Text  = ($lines -join "`r`n")
    }

    $script:SM_ApplyFilter = {
        if (-not $script:SM_UI -or -not $script:SM_UI.LbSites) { return }

        $lb = $script:SM_UI.LbSites
        $lb.BeginUpdate()
        try {
            $lb.Items.Clear()
            $script:SM_UI.LblSelected.Text = 'Select a street address on the left.'
            $script:SM_UI.RtbDetails.Clear()

            if (-not $script:SM_Data -or $script:SM_Data.Count -eq 0) { $script:SM_UI.LblCount.Text = '0 sites'; return }

            $siteQ = $script:SM_UI.TxtSite.Text.Trim()
            $cirQ  = $script:SM_UI.TxtCircuit.Text.Trim()

            $filtered = New-Object System.Collections.Generic.List[object]
            foreach ($s in $script:SM_Data) {

                # EXCLUDE ROWS WITHOUT STREET ADDRESS (NO FALLBACKS)
                if ([string]::IsNullOrWhiteSpace($s.StreetAddress)) { continue }

                if ($siteQ.Length -gt 0) {
                    $hay1 = ($s.StreetAddress + ' ' + $s.City)
                    if ($hay1 -notlike "*$siteQ*") { continue }
                }

                if ($cirQ.Length -gt 0) {
                    $hay2 = ($s.CircuitID + ' ' + $s.ServiceID + ' ' + $s.ISPProvider + ' ' + $s.ISPBackup + ' ' + $s.Account + ' ' + $s.Comments)
                    if ($hay2 -notlike "*$cirQ*") { continue }
                }

                [void]$filtered.Add($s)
            }

            $sorted = $filtered | Sort-Object -Property StreetAddress
            foreach ($s in $sorted) { [void]$lb.Items.Add($s.StreetAddress) }

            $script:SM_UI.LblCount.Text = "{0} sites" -f ($lb.Items.Count)
            if ($script:SM_Status) { & $script:SM_Status ("SiteInformation: {0} shown" -f $lb.Items.Count) }

        } finally { $lb.EndUpdate() }
    }

    $script:SM_QueueFilter = {
        if ($script:SM_FilterPending) { return }
        $script:SM_FilterPending = $true
        try {
            $null = $script:SM_UI.PageRoot.BeginInvoke([System.Action]{
                $script:SM_FilterPending = $false
                try { & $script:SM_ApplyFilter } catch { }
            })
        } catch {
            $script:SM_FilterPending = $false
            try { & $script:SM_ApplyFilter } catch { }
        }
    }

    $script:SM_LoadData = {
        param([switch]$Auto)

        try {
            $script:SM_ResolvedDataPath = Resolve-SMDataPath $script:SM_ResolvedDataPath

            if (-not (Test-Path -LiteralPath $script:SM_ResolvedDataPath)) {
                if ($script:SM_Status) { & $script:SM_Status ("SiteInformation: CSV not found ({0})" -f $script:SM_ResolvedDataPath) }
                return
            }

            if ($script:SM_Status) { & $script:SM_Status "Loading SiteInformation..." }
            $script:SM_UI.PageRoot.Cursor = 'WaitCursor'
            [System.Windows.Forms.Application]::DoEvents()

            $raw = Import-Csv -LiteralPath $script:SM_ResolvedDataPath

            $norm = New-Object System.Collections.Generic.List[object]
            foreach ($r in $raw) {
                $n = & $script:SM_NormalizeRow $r
                # ONLY KEEP ROWS WITH STREET ADDRESS
                if (-not [string]::IsNullOrWhiteSpace($n.StreetAddress)) { [void]$norm.Add($n) }
            }

            $script:SM_Data = $norm.ToArray()
            & $script:SM_ApplyFilter

            if ($script:SM_Status) {
                if ($Auto) { & $script:SM_Status ("Loaded {0} sites" -f $script:SM_Data.Count) }
                else { & $script:SM_Status ("Refreshed: {0} sites" -f $script:SM_Data.Count) }
            }

        } catch {
            _MsgErr ("Load failed:`r`n{0}" -f $_.Exception.Message)
            if ($script:SM_Status) { & $script:SM_Status "Load failed." }
        } finally {
            try { $script:SM_UI.PageRoot.Cursor = 'Default' } catch {}
        }
    }

    function Open-SiteInformationForEdit {
        param([string]$path)

        try {
            if (-not (Test-Path -LiteralPath $path)) {
                _MsgErr ("CSV not found:`r`n{0}" -f $path)
                return
            }

            if ($script:SM_Status) { & $script:SM_Status "Opening SiteInformation CSV for edit..." }

            try { Start-Process -FilePath $path | Out-Null; return } catch { }
            try { Start-Process -FilePath 'explorer.exe' -ArgumentList @('/select,', $path) | Out-Null; return } catch { }

            _MsgErr "Could not launch an editor for the CSV on this workstation."

        } catch {
            _MsgErr ("Open failed:`r`n{0}" -f $_.Exception.Message)
        }
    }

    $txtSite.Add_TextChanged({ try { if ($script:SM_QueueFilter) { & $script:SM_QueueFilter } } catch {} }) | Out-Null
    $txtCircuit.Add_TextChanged({ try { if ($script:SM_QueueFilter) { & $script:SM_QueueFilter } } catch {} }) | Out-Null

    $lbSites.Add_SelectedIndexChanged({
        try {
            if ($script:SM_UI.LbSites.SelectedItem) {
                & $script:SM_RenderDetailsByLabel ([string]$script:SM_UI.LbSites.SelectedItem)
            }
        } catch {
            _MsgErr ("Selection failed:`r`n{0}" -f $_.Exception.Message)
        }
    }) | Out-Null

    $script:SM_UI.BtnRefresh.Add_Click({ try { & $script:SM_LoadData } catch { _MsgErr $_.Exception.Message } }) | Out-Null
    $script:SM_UI.BtnUpdate.Add_Click({ Open-SiteInformationForEdit -path $script:SM_ResolvedDataPath }) | Out-Null

    if ($script:SM_Status) { & $script:SM_Status "Site Manager opened. Auto-loading SiteInformation once..." }

    if (-not $script:SM_AutoLoaded) {
        $script:SM_AutoLoaded = $true
        try {
            $null = $PageRoot.BeginInvoke([System.Action]{ try { & $script:SM_LoadData -Auto } catch { } })
        } catch {
            try { & $script:SM_LoadData -Auto } catch { }
        }
    }

    return $PageRoot
}
