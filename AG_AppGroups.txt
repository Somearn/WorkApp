# ===============================
# AG_AppGroups.txt
# Modern UI | App dropdown | Host search
# Embedded-capable: accepts -HostPanel to render inside main menu right pane
# CSV: \\lsfile03\netdoc$\Somearns_Folder\SomearnTK_app\appdata\AppGroups.csv
# ===============================

$ErrorActionPreference = 'Stop'

Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing
[System.Windows.Forms.Application]::EnableVisualStyles()

# ---------- UI HELPERS (script-scope so WinForms events can always find them) ----------
if (-not (Get-Command Set-Rounded -ErrorAction SilentlyContinue)) {
    function Set-Rounded {
        param(
            [Parameter(Mandatory)][System.Windows.Forms.Control]$Control,
            [int]$Radius = 10
        )
        try {
            if ($Control.Width -lt 2 -or $Control.Height -lt 2) { return }

            # Clamp radius so regions don't clip content when controls resize.
            $r = [int]$Radius
            if ($r -lt 0) { $r = 0 }
            $max = [int]([Math]::Floor([Math]::Min($Control.Width, $Control.Height) / 2))
            if ($r -gt $max) { $r = $max }
            if ($r -lt 1) { $Control.Region = $null; return }

            $rect = New-Object System.Drawing.Rectangle(0,0,$Control.Width,$Control.Height)
            $path = New-Object System.Drawing.Drawing2D.GraphicsPath
            $d = [int]($r * 2)

            $path.StartFigure()
            $path.AddArc($rect.X, $rect.Y, $d, $d, 180, 90)
            $path.AddArc($rect.Right - $d, $rect.Y, $d, $d, 270, 90)
            $path.AddArc($rect.Right - $d, $rect.Bottom - $d, $d, $d, 0, 90)
            $path.AddArc($rect.X, $rect.Bottom - $d, $d, $d, 90, 90)
            $path.CloseFigure()

            $Control.Region = New-Object System.Drawing.Region($path)
        } catch { }
    }
}

if (-not (Get-Command Enable-RoundedOnResize -ErrorAction SilentlyContinue)) {
    function Enable-RoundedOnResize {
        param(
            [Parameter(Mandatory)][System.Windows.Forms.Control]$Control,
            [int]$Radius = 10
        )
        try {
            # IMPORTANT:
            # WinForms event scriptblocks do NOT reliably keep local variables alive unless we close over them.
            # Without GetNewClosure(), Region can get stuck at the old size and CLIP the grid (what you're seeing).
            $rad = [int]$Radius

            $Control.Add_SizeChanged({
                try { Set-Rounded -Control $this -Radius $rad } catch { }
            }.GetNewClosure())

            # Initial apply (after handler is set)
            Set-Rounded -Control $Control -Radius $rad
        } catch { }
    }
}

function Show-AppGroupManagerView {
    param(
        [System.Windows.Forms.Control]$HostPanel
    )

    try {
        $CsvPath     = '\\lsfile03\netdoc$\Somearns_Folder\SomearnTK_app\appdata\AppGroups.csv'
        $GridColumns = @('AppGroup','Hostname','IPAddress','Role','Owner')

        if (-not (Test-Path -LiteralPath $CsvPath)) {
            throw "CSV not found: $CsvPath"
        }

        $isEmbedded = $false
        $hostForm = $null

        if ($HostPanel) {
            $isEmbedded = $true
        } else {
            $hostForm = New-Object System.Windows.Forms.Form
            $hostForm.Text = 'Application Groups'
            $hostForm.Size = New-Object System.Drawing.Size(1200,750)
            $hostForm.StartPosition = 'CenterScreen'
            $hostForm.BackColor = [System.Drawing.Color]::FromArgb(18,18,20)
            $hostForm.Font = New-Object System.Drawing.Font('Segoe UI',10)
        }

        # Root surface (always a panel, dock-fill)
        $root = New-Object System.Windows.Forms.Panel
        $root.Dock = 'Fill'
        $root.BackColor = [System.Drawing.Color]::FromArgb(18,18,20)
        $root.Font = New-Object System.Drawing.Font('Segoe UI',10)

        # ---------- TOP BAR ----------
        $top = New-Object System.Windows.Forms.Panel
        $top.Dock = 'Top'
        $top.Height = 86
        $top.BackColor = [System.Drawing.Color]::FromArgb(24,24,28)

        $title = New-Object System.Windows.Forms.Label
        $title.AutoSize = $true
        $title.Text = 'Application Groups'
        $title.ForeColor = 'White'
        $title.Font = New-Object System.Drawing.Font('Segoe UI',16,[System.Drawing.FontStyle]::Bold)
        $title.Location = New-Object System.Drawing.Point(18,18)
        $top.Controls.Add($title)

        # Right-side host panel for top-right buttons (Exit removed)
        $topRight = New-Object System.Windows.Forms.Panel
        $topRight.Dock = 'Right'
        $topRight.Width = 190
        $topRight.BackColor = [System.Drawing.Color]::FromArgb(24,24,28)
        $top.Controls.Add($topRight)

        $btnResync = New-Object System.Windows.Forms.Button
        $btnResync.Text = 'Resync Inventory'
        $btnResync.Width = 150
        $btnResync.Height = 32
        $btnResync.FlatStyle = 'Flat'
        $btnResync.FlatAppearance.BorderSize = 1
        $btnResync.FlatAppearance.BorderColor = [System.Drawing.Color]::FromArgb(55,55,70)
        $btnResync.BackColor = [System.Drawing.Color]::FromArgb(34,34,40)
        $btnResync.ForeColor = 'Gainsboro'
        $btnResync.Anchor = 'Top,Right'
        $btnResync.Location = New-Object System.Drawing.Point(28,38)
        $topRight.Controls.Add($btnResync)
        Enable-RoundedOnResize -Control $btnResync -Radius 10

        $lblApp = New-Object System.Windows.Forms.Label
        $lblApp.AutoSize = $true
        $lblApp.Text = 'Application'
        $lblApp.ForeColor = 'Gainsboro'
        $lblApp.Font = New-Object System.Drawing.Font('Segoe UI',9)
        $lblApp.Location = New-Object System.Drawing.Point(290,18)
        $top.Controls.Add($lblApp)

        $shellLeft = New-Object System.Windows.Forms.Panel
        $shellLeft.SetBounds(290,38,360,32)
        $shellLeft.BackColor = [System.Drawing.Color]::FromArgb(34,34,40)
        $shellLeft.Padding = '6,4,6,4'
        $top.Controls.Add($shellLeft)
        Enable-RoundedOnResize -Control $shellLeft -Radius 10

        $cmbApp = New-Object System.Windows.Forms.ComboBox
        $cmbApp.Dock = 'Fill'
        $cmbApp.FlatStyle = 'Flat'
        $cmbApp.BackColor = [System.Drawing.Color]::FromArgb(34,34,40)
        $cmbApp.ForeColor = 'Gainsboro'
        $cmbApp.DropDownStyle = 'DropDownList'
        $shellLeft.Controls.Add($cmbApp)

        $lblSearch = New-Object System.Windows.Forms.Label
        $lblSearch.AutoSize = $true
        $lblSearch.Text = 'Host Search'
        $lblSearch.ForeColor = 'Gainsboro'
        $lblSearch.Font = New-Object System.Drawing.Font('Segoe UI',9)
        $top.Controls.Add($lblSearch)

        $shellRight = New-Object System.Windows.Forms.Panel
        $shellRight.BackColor = [System.Drawing.Color]::FromArgb(34,34,40)
        $shellRight.Padding = '8,6,8,6'
        $shellRight.Anchor = 'Top,Right'
        $top.Controls.Add($shellRight)
        Enable-RoundedOnResize -Control $shellRight -Radius 10

        $txtSearch = New-Object System.Windows.Forms.TextBox
        $txtSearch.BorderStyle = 'None'
        $txtSearch.Dock = 'Fill'
        $txtSearch.BackColor = [System.Drawing.Color]::FromArgb(34,34,40)
        $txtSearch.ForeColor = 'Gainsboro'
        $shellRight.Controls.Add($txtSearch)

        # Application Info (shows only when an app is selected)
        $lblInfoHdr = New-Object System.Windows.Forms.Label
        $lblInfoHdr.AutoSize = $true
        $lblInfoHdr.Text = 'Application Info'
        $lblInfoHdr.ForeColor = 'Gainsboro'
        $lblInfoHdr.Font = New-Object System.Drawing.Font('Segoe UI',10,[System.Drawing.FontStyle]::Bold)
        $lblInfoHdr.Location = New-Object System.Drawing.Point(290,72)
        $lblInfoHdr.Visible = $false
        $top.Controls.Add($lblInfoHdr)

        $lblInfoText = New-Object System.Windows.Forms.Label
        $lblInfoText.AutoSize = $true
        $lblInfoText.ForeColor = 'White'
        $lblInfoText.Font = New-Object System.Drawing.Font('Segoe UI',9)
        $lblInfoText.Location = New-Object System.Drawing.Point(290,92)
        $lblInfoText.Visible = $false
        $lblInfoText.MaximumSize = New-Object System.Drawing.Size(560,0)
        $top.Controls.Add($lblInfoText)

        # Layout scriptblock (events can't see local functions reliably)
        $LayoutTop = ({
            try {
                $rightPad = $topRight.Width + 18

                # Host Search box anchored from the right
                $hsW = 260
                $hsX = $top.Width - ($rightPad + $hsW)
                $minX = $shellLeft.Right + 24

                if ($hsX -lt $minX) {
                    $hsX = $minX
                    $hsW = ($top.Width - $rightPad) - $hsX
                    if ($hsW -lt 160) { $hsW = 160 }
                }

                $shellRight.SetBounds($hsX, 38, $hsW, 32)
                $lblSearch.Location = New-Object System.Drawing.Point($hsX, 18)

                # AppInfo wrap width (same rightPad)
                $infoW = ($top.Width - $rightPad) - 290
                if ($infoW -lt 260) { $infoW = 260 }
                $lblInfoText.MaximumSize = New-Object System.Drawing.Size($infoW,0)

                $top.PerformLayout()
            } catch { }
        }).GetNewClosure()

        $top.Add_Resize({ & $LayoutTop }.GetNewClosure())

        $sep = New-Object System.Windows.Forms.Panel
        $sep.Dock = 'Bottom'
        $sep.Height = 1
        $sep.BackColor = [System.Drawing.Color]::FromArgb(45,45,55)
        $top.Controls.Add($sep)

        # ---------- BOTTOM ACTION BAR ----------
        $bottom = New-Object System.Windows.Forms.Panel
        $bottom.Dock = 'Bottom'
        $bottom.Height = 54
        $bottom.BackColor = [System.Drawing.Color]::FromArgb(18,18,20)
        $bottom.Padding = '12,10,12,10'

        $btnUpdate = New-Object System.Windows.Forms.Button
        $btnUpdate.Text = 'Update Database'
        $btnUpdate.Width = 180
        $btnUpdate.Height = 32
        $btnUpdate.FlatStyle = 'Flat'
        $btnUpdate.FlatAppearance.BorderSize = 1
        $btnUpdate.FlatAppearance.BorderColor = [System.Drawing.Color]::FromArgb(55,55,70)
        $btnUpdate.BackColor = [System.Drawing.Color]::FromArgb(34,34,40)
        $btnUpdate.ForeColor = 'Gainsboro'
        $btnUpdate.Location = New-Object System.Drawing.Point(12,10)
        $bottom.Controls.Add($btnUpdate)
        Enable-RoundedOnResize -Control $btnUpdate -Radius 10

        $lblHint = New-Object System.Windows.Forms.Label
        $lblHint.AutoSize = $true
        $lblHint.Text = 'Updating preloaded csv file only.'
        $lblHint.ForeColor = [System.Drawing.Color]::FromArgb(160,160,170)
        $lblHint.Font = New-Object System.Drawing.Font('Segoe UI',9)
        $lblHint.Location = New-Object System.Drawing.Point(204,16)
        $bottom.Controls.Add($lblHint)

        # ---------- STATUS ----------
        $lblStatus = New-Object System.Windows.Forms.Label
        $lblStatus.Dock = 'Bottom'
        $lblStatus.Height = 30
        $lblStatus.ForeColor = 'Gainsboro'
        $lblStatus.Padding = '14,6,0,0'
        $lblStatus.BackColor = [System.Drawing.Color]::FromArgb(18,18,20)

        # ---------- GRID HOST PANEL ----------
        $gridHost = New-Object System.Windows.Forms.Panel
        $gridHost.Dock = 'Fill'
        $gridHost.BackColor = [System.Drawing.Color]::FromArgb(18,18,20)
        $gridHost.Padding = '12,10,12,10'

        $gridShell = New-Object System.Windows.Forms.Panel
        $gridShell.Dock = 'Fill'
        $gridShell.BackColor = [System.Drawing.Color]::FromArgb(45,45,55)
        $gridShell.Padding = '1,1,1,1'
        $gridHost.Controls.Add($gridShell)
        Enable-RoundedOnResize -Control $gridShell -Radius 12

        $gridInner = New-Object System.Windows.Forms.Panel
        $gridInner.Dock = 'Fill'
        $gridInner.BackColor = [System.Drawing.Color]::FromArgb(24,24,28)
        $gridShell.Controls.Add($gridInner)
        Enable-RoundedOnResize -Control $gridInner -Radius 12

        # ---------- GRID ----------
        $grid = New-Object System.Windows.Forms.DataGridView
        $grid.Dock = 'Fill'
        $grid.ReadOnly = $true
        $grid.MultiSelect = $false
        $grid.AllowUserToAddRows = $false
        $grid.AllowUserToDeleteRows = $false
        $grid.AllowUserToResizeRows = $false
        $grid.BorderStyle = 'None'
        $grid.CellBorderStyle = 'SingleHorizontal'
        $grid.GridColor = [System.Drawing.Color]::FromArgb(40,40,48)
        $grid.RowHeadersVisible = $false
        $grid.ColumnHeadersVisible = $true
        $grid.SelectionMode = 'FullRowSelect'
        $grid.AutoSizeColumnsMode = 'Fill'
        $grid.BackgroundColor = [System.Drawing.Color]::FromArgb(24,24,28)

        $grid.DefaultCellStyle.BackColor = [System.Drawing.Color]::FromArgb(24,24,28)
        $grid.DefaultCellStyle.ForeColor = 'Gainsboro'
        $grid.DefaultCellStyle.SelectionBackColor = [System.Drawing.Color]::FromArgb(55,95,235)
        $grid.DefaultCellStyle.SelectionForeColor = 'White'
        $grid.DefaultCellStyle.Padding = New-Object System.Windows.Forms.Padding(6,0,6,0)

        $grid.ColumnHeadersDefaultCellStyle.BackColor = [System.Drawing.Color]::FromArgb(30,30,36)
        $grid.ColumnHeadersDefaultCellStyle.ForeColor = 'White'
        $grid.ColumnHeadersDefaultCellStyle.Font = New-Object System.Drawing.Font('Segoe UI',10,[System.Drawing.FontStyle]::Bold)
        $grid.ColumnHeadersDefaultCellStyle.Alignment = 'MiddleLeft'
        $grid.EnableHeadersVisualStyles = $false
        $grid.ColumnHeadersHeight = 36
        $grid.RowTemplate.Height = 30

        $grid.AutoGenerateColumns = $false
        $grid.Columns.Clear()
        foreach ($c in $GridColumns) {
            $col = New-Object System.Windows.Forms.DataGridViewTextBoxColumn
            $col.HeaderText = $c
            $col.DataPropertyName = $c
            $col.Name = $c
            $col.SortMode = 'Automatic'
            [void]$grid.Columns.Add($col)
        }

        $gridInner.Controls.Add($grid)

        # BindingSource
        $bs = New-Object System.Windows.Forms.BindingSource
        $grid.DataSource = $bs

        # Assemble root with stable dock order
        $root.Controls.Add($gridHost)
        $root.Controls.Add($lblStatus)
        $root.Controls.Add($bottom)
        $root.Controls.Add($top)

        $root.Controls.SetChildIndex($top, 3)
        $root.Controls.SetChildIndex($gridHost, 2)
        $root.Controls.SetChildIndex($lblStatus, 1)
        $root.Controls.SetChildIndex($bottom, 0)

        # ---------- STATE ----------
        $state = [pscustomobject]@{
            CsvPath        = $CsvPath
            GridColumns    = $GridColumns
            AllRows        = @()
            Binding        = $bs
            CmbApp         = $cmbApp
            TxtSearch      = $txtSearch
            LblStatus      = $lblStatus
            Grid           = $grid
            Busy           = $false
            LblInfoHdr     = $lblInfoHdr
            LblInfoText    = $lblInfoText
            TopPanel       = $top
            TopRight       = $topRight
            BaseTopHeight  = 86
        }

        $root.Tag = $state

        # --- helper to read "App info" column variants safely ---
        $GetAppInfo = ({
            param($Row)
            if ($null -eq $Row) { return '' }
            $names = @('AppInfo','App info','App info:','ApplicationInfo','Application Info','Application Info:')
            foreach ($n in $names) {
                if ($Row.PSObject.Properties.Name -contains $n) {
                    $v = [string]$Row.$n
                    if ($v) { return $v.Trim() }
                }
            }
            return ''
        }).GetNewClosure()

        $LoadRows = ({
            $rows = @()
            if (Test-Path -LiteralPath $CsvPath) {
                $rows = Import-Csv -LiteralPath $CsvPath
            }
            if (-not $rows) { $rows = @() }
            return $rows
        }).GetNewClosure()

        $RefreshApps = ({
            param([object[]]$Rows)

            $apps = @('(All)')
            if ($Rows -and $Rows.Count -gt 0) {
                $apps = @('(All)') + ($Rows | Select-Object -ExpandProperty AppGroup -Unique | Sort-Object)
            }

            $sel = [string]$state.CmbApp.Text
            [void]$state.CmbApp.Items.Clear()
            $state.CmbApp.Items.AddRange($apps)

            if ($sel -and ($state.CmbApp.Items -contains $sel)) { $state.CmbApp.SelectedItem = $sel }
            else { $state.CmbApp.SelectedIndex = 0 }
        }).GetNewClosure()

        $SyncTop = ({
            param([string]$AppSel)

            $baseH = [int]$state.BaseTopHeight

            if (-not $AppSel -or $AppSel -eq '(All)') {
                $state.LblInfoHdr.Visible = $false
                $state.LblInfoText.Visible = $false
                $state.TopPanel.Height = $baseH
                return
            }

            $infoText = [string]$state.LblInfoText.Text
            if (-not $infoText) {
                $state.LblInfoHdr.Visible = $false
                $state.LblInfoText.Visible = $false
                $state.TopPanel.Height = $baseH
                return
            }

            $state.LblInfoHdr.Visible = $true
            $state.LblInfoText.Visible = $true

            $rightPad = $state.TopRight.Width + 18
            $infoW = ($state.TopPanel.Width - $rightPad) - 290
            if ($infoW -lt 260) { $infoW = 260 }
            $state.LblInfoText.MaximumSize = New-Object System.Drawing.Size($infoW,0)

            $state.TopPanel.PerformLayout()

            $bottomY = $state.LblInfoText.Bottom + 12
            if ($bottomY -lt $baseH) { $bottomY = $baseH }
            $state.TopPanel.Height = $bottomY
        }).GetNewClosure()

        $Apply = ({
            if ($state.Busy) { return }
            $state.Busy = $true

            try {
                $appSel = ''
                if ($state.CmbApp.SelectedItem) { $appSel = [string]$state.CmbApp.SelectedItem }
                else { $appSel = [string]$state.CmbApp.Text }
                $appSel = $appSel.Trim()

                $q = ([string]$state.TxtSearch.Text).Trim()
                $qLow = $q.ToLower()

                $list = New-Object System.Collections.ArrayList

                foreach ($r in $state.AllRows) {

                    $rg = ([string]$r.AppGroup).Trim()

                    if ($appSel -and $appSel -ne '(All)') {
                        if ($rg -ne $appSel) { continue }
                    }

                    if ($qLow) {
                        $blob = ("{0} {1} {2} {3} {4}" -f
                            [string]$r.AppGroup,
                            [string]$r.Hostname,
                            [string]$r.IPAddress,
                            [string]$r.Role,
                            [string]$r.Owner
                        ).ToLower()

                        if (-not $blob.Contains($qLow)) { continue }
                    }

                    [void]$list.Add([pscustomobject]@{
                        AppGroup   = [string]$r.AppGroup
                        Hostname   = [string]$r.Hostname
                        IPAddress  = [string]$r.IPAddress
                        Role       = [string]$r.Role
                        Owner      = [string]$r.Owner
                    })
                }

                $state.Binding.DataSource = $null
                $state.Binding.DataSource = $list

                $appCount = 0
                if ($list.Count -gt 0) { $appCount = (($list | Select-Object -ExpandProperty AppGroup -Unique).Count) }
                $state.LblStatus.Text = ("{0} Hosts | {1} AppGroups" -f $list.Count, $appCount)

                $info = ''
                if ($appSel -and $appSel -ne '(All)') {
                    foreach ($rr in $state.AllRows) {
                        if (([string]$rr.AppGroup).Trim() -ne $appSel) { continue }
                        $v = & $GetAppInfo $rr
                        if ($v) { $info = $v; break }
                    }
                }
                $state.LblInfoText.Text = $info

                & $SyncTop $appSel

            } finally {
                $state.Busy = $false
            }
        }).GetNewClosure()

        $Reload = ({
            $state.AllRows = & $LoadRows
            & $RefreshApps $state.AllRows
            & $Apply
        }).GetNewClosure()

        # Initial load
        & $Reload

        # ---------- EVENT WIRING ----------
        $cmbApp.Add_SelectedIndexChanged({ & $Apply }.GetNewClosure())
        $txtSearch.Add_TextChanged({ & $Apply }.GetNewClosure())
        $btnResync.Add_Click({ & $Reload }.GetNewClosure())

        $btnUpdate.Add_Click({
            $path = [string]$state.CsvPath
            if (-not $path) {
                [System.Windows.Forms.MessageBox]::Show("CSV path is missing.","SomearnTK","OK","Error") | Out-Null
                return
            }
            
            # SECURITY FIX: Validate file extension to prevent execution of dangerous files
            # Use GetExtension to avoid bypasses like "malicious.exe.csv"
            if ([System.IO.Path]::GetExtension($path) -ine '.csv') {
                [System.Windows.Forms.MessageBox]::Show("Invalid file type. Only CSV files are allowed.","SomearnTK","OK","Error") | Out-Null
                return
            }
            
            if (-not (Test-Path -LiteralPath $path)) {
                [System.Windows.Forms.MessageBox]::Show("CSV not found:`r`n$path","SomearnTK","OK","Error") | Out-Null
                return
            }

            try {
                # Resolve to absolute path to prevent path traversal
                $resolvedPath = (Resolve-Path -LiteralPath $path).Path
                
                Start-Process -FilePath 'excel.exe' -ArgumentList "`"$resolvedPath`"" | Out-Null
                [System.Windows.Forms.MessageBox]::Show(
                    "Database opened in Excel.`r`nWhen you finish editing and save, click Resync Inventory to reload.",
                    'SomearnTK',
                    [System.Windows.Forms.MessageBoxButtons]::OK,
                    [System.Windows.Forms.MessageBoxIcon]::Information
                ) | Out-Null
            } catch {
                # Fallback to default application if Excel not available
                try {
                    Start-Process -FilePath $resolvedPath | Out-Null
                    [System.Windows.Forms.MessageBox]::Show(
                        "Database opened.`r`nWhen you finish editing and save, click Resync Inventory to reload.",
                        'SomearnTK',
                        [System.Windows.Forms.MessageBoxButtons]::OK,
                        [System.Windows.Forms.MessageBoxIcon]::Information
                    ) | Out-Null
                } catch {
                    [System.Windows.Forms.MessageBox]::Show(
                        "Failed to open database file: $($_.Exception.Message)",
                        'SomearnTK',
                        [System.Windows.Forms.MessageBoxButtons]::OK,
                        [System.Windows.Forms.MessageBoxIcon]::Error
                    ) | Out-Null
                }
            }
        }.GetNewClosure())

        # Show (embedded vs window)
        if ($isEmbedded) {
            $HostPanel.SuspendLayout()
            $HostPanel.Controls.Clear()
            $HostPanel.Controls.Add($root)
            $HostPanel.ResumeLayout()
            $root.BringToFront()

            try {
                & $LayoutTop
                & $Apply
            } catch { }
        } else {
            $hostForm.Controls.Add($root)
            $hostForm.Add_Shown({ try { & $LayoutTop; & $Apply } catch { } }.GetNewClosure())
            $hostForm.Show()
        }

    } catch {
        $msg = $_.Exception.Message
        $pos = $null
        if ($_.InvocationInfo -and $_.InvocationInfo.PositionMessage) { $pos = $_.InvocationInfo.PositionMessage }
        if ($pos) { $msg = $msg + "`r`n`r`n" + $pos }

        [System.Windows.Forms.MessageBox]::Show(
            $msg,
            'SomearnTK',
            'OK',
            'Error'
        ) | Out-Null
    }
}
