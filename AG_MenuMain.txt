$ErrorActionPreference = 'Stop'

Add-Type -AssemblyName System.Windows.Forms | Out-Null
Add-Type -AssemblyName System.Drawing       | Out-Null
[System.Windows.Forms.Application]::EnableVisualStyles()

# MENU LINK: Phone Book (Menu Button 2)
function Show-PhoneBookDirectoryView {
    [CmdletBinding()]
    param(
        [Parameter()][System.Windows.Forms.Panel]$HostPanel
    )

    function _MsgErr([string]$t){ [System.Windows.Forms.MessageBox]::Show($t,'SomearnTK','OK','Error') | Out-Null }

    try {
        if (-not $HostPanel) { throw "Host panel not available." }

        if (-not (Get-Command -Name 'Get-AG_PhoneBookDirectoryPage' -ErrorAction SilentlyContinue)) {

            $candidates = New-Object System.Collections.Generic.List[string]

            if ($script:AgScriptsFolder -and -not [string]::IsNullOrWhiteSpace($script:AgScriptsFolder)) {
                $candidates.Add((Join-Path $script:AgScriptsFolder 'AG_PhoneBookDirectory.txt')) | Out-Null
            }

            if ($script:AG_LaunchPath -and -not [string]::IsNullOrWhiteSpace($script:AG_LaunchPath)) {
                $launcherDir = Split-Path -Parent $script:AG_LaunchPath
                $candidates.Add((Join-Path $launcherDir 'AG_PhoneBookDirectory.txt')) | Out-Null
            }

            if ($script:AgScriptsFolder -and -not [string]::IsNullOrWhiteSpace($script:AgScriptsFolder)) {
                $root = Split-Path -Parent $script:AgScriptsFolder
                $candidates.Add((Join-Path $root 'appscripts\AG_PhoneBookDirectory.txt')) | Out-Null
            }

            foreach ($p in ($candidates | Select-Object -Unique)) {
                if ($p -and (Test-Path -LiteralPath $p)) {
                    $code = Get-Content -LiteralPath $p -Raw
                    . ([scriptblock]::Create($code))
                    break
                }
            }
        }

        if (-not (Get-Command -Name 'Get-AG_PhoneBookDirectoryPage' -ErrorAction SilentlyContinue)) {
            throw "PhoneBook module not loaded. Missing function: Get-AG_PhoneBookDirectoryPage"
        }

        $HostPanel.SuspendLayout()
        $HostPanel.Controls.Clear()

        $dataPath = if ($script:AgScriptsFolder -and -not [string]::IsNullOrWhiteSpace($script:AgScriptsFolder)) {
            Join-Path $script:AgScriptsFolder 'PhoneBook.csv'
        } else {
            'PhoneBook.csv'
        }

        $page = Get-AG_PhoneBookDirectoryPage -SetStatus {
            param($t)
            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = $t }
        } -DataPath $dataPath

        $page.Dock = 'Fill'
        [void]$HostPanel.Controls.Add($page)

        if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opened: Phone Book Directory' }

    } catch {
        _MsgErr $_.Exception.Message
        if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Phone Book failed to open.' }
    } finally {
        try { $HostPanel.ResumeLayout() } catch {}
    }
}

# MENU LINK: Site Manager (Menu Button 3)
function Show-SiteManagerView {
    [CmdletBinding()]
    param(
        [Parameter()][System.Windows.Forms.Panel]$HostPanel
    )

    function _MsgErr([string]$t){ [System.Windows.Forms.MessageBox]::Show($t,'SomearnTK','OK','Error') | Out-Null }

    try {
        if (-not $HostPanel) { throw "Host panel not available." }

        if (-not (Get-Command -Name 'Get-AG_SiteManagerPage' -ErrorAction SilentlyContinue) -and
            -not (Get-Command -Name 'Show-SiteManager'      -ErrorAction SilentlyContinue)) {

            $candidates = New-Object System.Collections.Generic.List[string]

            if ($script:AgScriptsFolder -and -not [string]::IsNullOrWhiteSpace($script:AgScriptsFolder)) {
                $candidates.Add((Join-Path $script:AgScriptsFolder 'AG_SiteManager.txt')) | Out-Null
            }

            if ($script:AG_LaunchPath -and -not [string]::IsNullOrWhiteSpace($script:AG_LaunchPath)) {
                $launcherDir = Split-Path -Parent $script:AG_LaunchPath
                $candidates.Add((Join-Path $launcherDir 'AG_SiteManager.txt')) | Out-Null
            }

            if ($script:AgScriptsFolder -and -not [string]::IsNullOrWhiteSpace($script:AgScriptsFolder)) {
                $root = Split-Path -Parent $script:AgScriptsFolder
                $candidates.Add((Join-Path $root 'appscripts\AG_SiteManager.txt')) | Out-Null
            }

            foreach ($p in ($candidates | Select-Object -Unique)) {
                if ($p -and (Test-Path -LiteralPath $p)) {
                    $code = Get-Content -LiteralPath $p -Raw
                    . ([scriptblock]::Create($code))
                    break
                }
            }
        }

        if (Get-Command -Name 'Get-AG_SiteManagerPage' -ErrorAction SilentlyContinue) {

            $HostPanel.SuspendLayout()
            $HostPanel.Controls.Clear()

            $dataPath = if ($script:AgScriptsFolder -and -not [string]::IsNullOrWhiteSpace($script:AgScriptsFolder)) {
                Join-Path $script:AgScriptsFolder 'SiteInformation.csv'
            } else {
                'SiteInformation.csv'
            }

            $page = Get-AG_SiteManagerPage -SetStatus {
                param($t)
                if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = $t }
            } -DataPath $dataPath

            $page.Dock = 'Fill'
            [void]$HostPanel.Controls.Add($page)

            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opened: Site Manager' }
            return
        }

        if (Get-Command -Name 'Show-SiteManager' -ErrorAction SilentlyContinue) {
            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opening: Site Manager' }
            Show-SiteManager
            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opened: Site Manager (window)' }
            return
        }

        throw "Site Manager module not loaded. Missing function: Get-AG_SiteManagerPage or Show-SiteManager"

    } catch {
        _MsgErr $_.Exception.Message
        if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Site Manager failed to open.' }
    } finally {
        try { $HostPanel.ResumeLayout() } catch {}
    }
}

# MENU LINK: Application Manager (Menu Button 1)
function Show-AppGroupManagerView {
    [CmdletBinding()]
    param(
        [Parameter()][System.Windows.Forms.Panel]$HostPanel
    )

    function _MsgErr([string]$t){ [System.Windows.Forms.MessageBox]::Show($t,'SomearnTK','OK','Error') | Out-Null }

    try {
        if (-not $HostPanel) { throw "Host panel not available." }

        if (-not (Get-Command -Name 'Get-AG_AppGroupsPage' -ErrorAction SilentlyContinue) -and
            -not (Get-Command -Name 'Show-AppGroupManager' -ErrorAction SilentlyContinue)) {

            $candidates = New-Object System.Collections.Generic.List[string]

            if ($script:AgScriptsFolder -and -not [string]::IsNullOrWhiteSpace($script:AgScriptsFolder)) {
                foreach ($fn in @('AG_AppGroups.txt','AG_AppGroupManager.txt','AG_AppGroupsManager.txt')) {
                    $candidates.Add((Join-Path $script:AgScriptsFolder $fn)) | Out-Null
                }
            }

            if ($script:AG_LaunchPath -and -not [string]::IsNullOrWhiteSpace($script:AG_LaunchPath)) {
                $launcherDir = Split-Path -Parent $script:AG_LaunchPath
                foreach ($fn in @('AG_AppGroups.txt','AG_AppGroupManager.txt','AG_AppGroupsManager.txt')) {
                    $candidates.Add((Join-Path $launcherDir $fn)) | Out-Null
                }
            }

            foreach ($p in ($candidates | Select-Object -Unique)) {
                if ($p -and (Test-Path -LiteralPath $p)) {
                    $code = Get-Content -LiteralPath $p -Raw
                    . ([scriptblock]::Create($code))
                    break
                }
            }
        }

        if (Get-Command -Name 'Get-AG_AppGroupsPage' -ErrorAction SilentlyContinue) {
            $HostPanel.SuspendLayout()
            $HostPanel.Controls.Clear()

            $dataPath = if ($script:AgScriptsFolder -and -not [string]::IsNullOrWhiteSpace($script:AgScriptsFolder)) {
                Join-Path $script:AgScriptsFolder 'AppGroups.csv'
            } else {
                'AppGroups.csv'
            }

            $page = Get-AG_AppGroupsPage -SetStatus {
                param($t)
                if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = $t }
            } -DataPath $dataPath

            $page.Dock = 'Fill'
            [void]$HostPanel.Controls.Add($page)

            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opened: Application Manager' }
            return
        }

        if (Get-Command -Name 'Show-AppGroupManager' -ErrorAction SilentlyContinue) {
            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opening: Application Manager' }
            Show-AppGroupManager
            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opened: Application Manager (window)' }
            return
        }

        throw "Application Manager module not loaded. Missing Get-AG_AppGroupsPage or Show-AppGroupManager."

    } catch {
        _MsgErr $_.Exception.Message
        if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Application Manager failed to open.' }
    }
}

# MENU LINK: Script Launcher (Menu Button 4) - EMBEDDED from AG_ScriptLauncherControlRoom.txt
function Show-ScriptLauncherView {
    [CmdletBinding()]
    param(
        [Parameter()][System.Windows.Forms.Panel]$HostPanel
    )

    function _MsgErr([string]$t){ [System.Windows.Forms.MessageBox]::Show($t,'SomearnTK','OK','Error') | Out-Null }

    try {
        if (-not $HostPanel) { throw "Host panel not available." }

        if (-not (Get-Command -Name 'Get-AG_ScriptLauncherPage' -ErrorAction SilentlyContinue)) {

            $candidates = New-Object System.Collections.Generic.List[string]

            if ($script:AgScriptsFolder -and -not [string]::IsNullOrWhiteSpace($script:AgScriptsFolder)) {
                $candidates.Add((Join-Path $script:AgScriptsFolder 'AG_ScriptLauncherControlRoom.txt')) | Out-Null
            }

            if ($script:AG_LaunchPath -and -not [string]::IsNullOrWhiteSpace($script:AG_LaunchPath)) {
                $launcherDir = Split-Path -Parent $script:AG_LaunchPath
                $candidates.Add((Join-Path $launcherDir 'AG_ScriptLauncherControlRoom.txt')) | Out-Null
            }

            foreach ($p in ($candidates | Select-Object -Unique)) {
                if ($p -and (Test-Path -LiteralPath $p)) {
                    $code = Get-Content -LiteralPath $p -Raw
                    . ([scriptblock]::Create($code))
                    break
                }
            }
        }

        if (-not (Get-Command -Name 'Get-AG_ScriptLauncherPage' -ErrorAction SilentlyContinue)) {
            throw "Script Launcher module not loaded. Missing function: Get-AG_ScriptLauncherPage"
        }

        $scriptsPath = '\\lsfile03\netdoc$\Somearns_Folder\SomearnTK_app\appscripts'

        $HostPanel.SuspendLayout()
        $HostPanel.Controls.Clear()

        $page = Get-AG_ScriptLauncherPage -SetStatus {
            param($t)
            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = $t }
        } -ScriptsPath $scriptsPath

        $page.Dock = 'Fill'
        [void]$HostPanel.Controls.Add($page)

        if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opened: Script Launcher' }

    } catch {
        _MsgErr $_.Exception.Message
        if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Script Launcher failed to open.' }
    } finally {
        try { $HostPanel.ResumeLayout() } catch {}
    }
}

# MENU LINK: Network Tool (Menu Button 5)
function Show-NetworkToolView {
    [CmdletBinding()]
    param(
        [Parameter()][System.Windows.Forms.Panel]$HostPanel
    )

    function _MsgErr([string]$t){ [System.Windows.Forms.MessageBox]::Show($t,'SomearnTK','OK','Error') | Out-Null }

    try {
        if (-not $HostPanel) { throw "Host panel not available." }

        if (-not (Get-Command -Name 'Get-AG_NetworkToolPage' -ErrorAction SilentlyContinue)) {

            $candidates = New-Object System.Collections.Generic.List[string]

            if ($script:AgScriptsFolder -and -not [string]::IsNullOrWhiteSpace($script:AgScriptsFolder)) {
                $candidates.Add((Join-Path $script:AgScriptsFolder 'AG_NetworkTool.txt')) | Out-Null
            }

            if ($script:AG_LaunchPath -and -not [string]::IsNullOrWhiteSpace($script:AG_LaunchPath)) {
                $launcherDir = Split-Path -Parent $script:AG_LaunchPath
                $candidates.Add((Join-Path $launcherDir 'AG_NetworkTool.txt')) | Out-Null
            }

            if ($script:AgScriptsFolder -and -not [string]::IsNullOrWhiteSpace($script:AgScriptsFolder)) {
                $root = Split-Path -Parent $script:AgScriptsFolder
                $candidates.Add((Join-Path $root 'appscripts\AG_NetworkTool.txt')) | Out-Null
            }

            foreach ($p in ($candidates | Select-Object -Unique)) {
                if ($p -and (Test-Path -LiteralPath $p)) {
                    $code = Get-Content -LiteralPath $p -Raw
                    . ([scriptblock]::Create($code))
                    break
                }
            }
        }

        if (-not (Get-Command -Name 'Get-AG_NetworkToolPage' -ErrorAction SilentlyContinue)) {
            throw "Network Tool module not loaded. Missing function: Get-AG_NetworkToolPage"
        }

        $HostPanel.SuspendLayout()
        $HostPanel.Controls.Clear()

        $page = Get-AG_NetworkToolPage -SetStatus {
            param($t)
            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = $t }
        }

        $page.Dock = 'Fill'
        [void]$HostPanel.Controls.Add($page)

        if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opened: Network Tool' }

    } catch {
        _MsgErr $_.Exception.Message
        if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Network Tool failed to open.' }
    } finally {
        try { $HostPanel.ResumeLayout() } catch {}
    }
}

function Show-MenuMain {

    if ($script:AG_MainForm -and -not $script:AG_MainForm.IsDisposed) {
        try { $script:AG_MainForm.Activate(); $script:AG_MainForm.BringToFront() } catch {}
        return
    }

    function MsgInfo([string]$t){ [System.Windows.Forms.MessageBox]::Show($t,'SomearnTK','OK','Information') | Out-Null }
    function MsgErr([string]$t){  [System.Windows.Forms.MessageBox]::Show($t,'SomearnTK','OK','Error')       | Out-Null }

    function Invoke-CommandName([string]$name) {
        try {
            if ([string]::IsNullOrWhiteSpace($name)) { throw "Button command is blank." }

            $cmd = Get-Command -Name $name -ErrorAction SilentlyContinue
            if (-not $cmd) { throw "$name not found (module not loaded)." }

            $p = $cmd.Parameters.Keys

            if ($script:AG_RightHost -and ($p -contains 'HostPanel')) {
                & $name -HostPanel $script:AG_RightHost
            } elseif ($script:AG_RightHost -and ($p -contains 'Parent')) {
                & $name -Parent $script:AG_RightHost
            } elseif ($script:AG_RightHost -and ($p -contains 'MainPanel')) {
                & $name -MainPanel $script:AG_RightHost
            } else {
                & $name
            }

            if ($script:AG_StatusLabel) {
                $script:AG_StatusLabel.Text = ("Opened: " + $name)
            }

        } catch {
            MsgErr $_.Exception.Message
        }
    }

    $form = New-Object System.Windows.Forms.Form
    $form.Text = 'SomearnTK'
    $form.StartPosition = 'CenterScreen'
    $form.Size = New-Object System.Drawing.Size(1400,800)
    $form.MinimumSize = New-Object System.Drawing.Size(1100,650)
    $form.BackColor = [System.Drawing.Color]::FromArgb(10,10,10)
    $form.FormBorderStyle = 'Sizable'
    $script:AG_MainForm = $form

    $rightShell = New-Object System.Windows.Forms.Panel
    $rightShell.Dock = 'Fill'
    $rightShell.BackColor = [System.Drawing.Color]::FromArgb(10,10,10)
    $rightShell.Padding = '12,10,12,10'
    $form.Controls.Add($rightShell)

    $rightHost = New-Object System.Windows.Forms.Panel
    $rightHost.Dock = 'Fill'
    $rightHost.BackColor = [System.Drawing.Color]::FromArgb(10,10,10)
    $rightShell.Controls.Add($rightHost)
    $script:AG_RightHost = $rightHost

    $left = New-Object System.Windows.Forms.Panel
    $left.Dock = 'Left'
    $left.Width = 210
    $left.MinimumSize = New-Object System.Drawing.Size(210,0)
    $left.MaximumSize = New-Object System.Drawing.Size(210,0)
    $left.BackColor = [System.Drawing.Color]::FromArgb(18,18,22)
    $form.Controls.Add($left)

    $bottom = New-Object System.Windows.Forms.Panel
    $bottom.Dock = 'Bottom'
    $bottom.Height = 30
    $bottom.BackColor = [System.Drawing.Color]::FromArgb(16,16,18)
    $bottom.Padding = '12,6,12,6'
    $form.Controls.Add($bottom)

    $status = New-Object System.Windows.Forms.Label
    $status.AutoSize = $true
    $status.Text = 'Ready.'
    $status.ForeColor = [System.Drawing.Color]::FromArgb(150,150,160)
    $status.Font = New-Object System.Drawing.Font('Segoe UI',9)
    $bottom.Controls.Add($status)
    $script:AG_StatusLabel = $status

    $top = New-Object System.Windows.Forms.Panel
    $top.Dock = 'Top'
    $top.Height = 44
    $top.BackColor = [System.Drawing.Color]::FromArgb(20,20,24)
    $form.Controls.Add($top)

    $topLabel = New-Object System.Windows.Forms.Label
    $topLabel.Text = 'Network: IDLE      IS Ops Appstack by SH'
    $topLabel.AutoSize = $true
    $topLabel.ForeColor = 'Gainsboro'
    $topLabel.Font = New-Object System.Drawing.Font('Segoe UI',9,[System.Drawing.FontStyle]::Bold)
    $topLabel.Location = New-Object System.Drawing.Point(520,13)
    $top.Controls.Add($topLabel)

    function New-MenuButton([string]$text, [int]$y, [string]$commandName) {
        $b = New-Object System.Windows.Forms.Button
        $b.Text = $text
        $b.SetBounds(12,$y,186,32)
        $b.FlatStyle = 'Flat'
        $b.FlatAppearance.BorderSize = 1
        $b.FlatAppearance.BorderColor = [System.Drawing.Color]::FromArgb(130,140,255)
        $b.BackColor = [System.Drawing.Color]::FromArgb(85,95,235)
        $b.ForeColor = 'White'
        $b.Font = New-Object System.Drawing.Font('Segoe UI',9.5,[System.Drawing.FontStyle]::Bold)

        $b.Tag = $commandName

        $b.Add_Click({
            $name = [string]$this.Tag
            if ($this.Text -eq 'Dashboard') { MsgInfo 'Dashboard not implemented yet.'; return }
            if ($name -eq '__NOTIMPL__') { MsgInfo ($this.Text + ' not implemented yet.'); return }
            Invoke-CommandName $name
        })

        return $b
    }

    $y = 12
    $left.Controls.Add((New-MenuButton 'Dashboard' $y '__NOTIMPL__')); $y += 40

    $left.Controls.Add((New-MenuButton 'Application Manager' $y 'Show-AppGroupManagerView')); $y += 40
    $left.Controls.Add((New-MenuButton 'Phone Book' $y 'Show-PhoneBookDirectoryView')); $y += 40
    $left.Controls.Add((New-MenuButton 'Site Manager' $y 'Show-SiteManagerView')); $y += 40
    $left.Controls.Add((New-MenuButton 'Script Launcher' $y 'Show-ScriptLauncherView')); $y += 40
    $left.Controls.Add((New-MenuButton 'Network Tool' $y 'Show-NetworkToolView')); $y += 40

    for ($i=6; $i -le 15; $i++) {
        $left.Controls.Add((New-MenuButton "Item $i" $y '__NOTIMPL__'))
        $y += 40
    }

    $btnExit = New-Object System.Windows.Forms.Button
    $btnExit.Text = 'EXIT'
    $btnExit.SetBounds(12, $left.Height - 60, 186, 44)
    $btnExit.Anchor = 'Left,Bottom'
    $btnExit.FlatStyle = 'Flat'
    $btnExit.FlatAppearance.BorderSize = 0
    $btnExit.BackColor = [System.Drawing.Color]::FromArgb(200,60,60)
    $btnExit.ForeColor = 'White'
    $btnExit.Font = New-Object System.Drawing.Font('Segoe UI',10,[System.Drawing.FontStyle]::Bold)
    $btnExit.Add_Click({ $form.Close() })
    $left.Controls.Add($btnExit)

    $form.Add_FormClosed({
        $script:AG_MainForm = $null
        $script:AG_RightHost = $null
        $script:AG_StatusLabel = $null
    })

    [void]$form.ShowDialog()
}
