$ErrorActionPreference = 'Stop'

Add-Type -AssemblyName System.Windows.Forms | Out-Null
Add-Type -AssemblyName System.Drawing       | Out-Null
[System.Windows.Forms.Application]::EnableVisualStyles()

# ----------------------------
# SECURITY HARDENING (NO IEX / NO ScriptBlock::Create)
# - Loads only from a single trusted base folder
# - Dot-sources the module FILE PATH (not string-to-execution)
# - Blocks traversal / non-base paths (fail-closed)
# - Integrates with security logging subsystem
# ----------------------------

# Load security helpers first
$securityHelpersPath = Join-Path $script:AG_AppDataPath 'AG_SecurityHelpers.txt'
if (Test-Path -LiteralPath $securityHelpersPath) {
    try {
        . $securityHelpersPath
        Write-SecurityLog -EventType Load -Message "Security helpers loaded" -Details $securityHelpersPath
    } catch {
        # If security helpers fail to load, continue with basic validation
        function Write-SecurityLog { param($EventType, $Message, $Details) }
    }
} else {
    # Stub function if security helpers not available
    function Write-SecurityLog { param($EventType, $Message, $Details) }
}

# Trusted base for all TXT modules (override by setting $script:AgScriptsFolder earlier in your launcher)
$script:AG_TrustedBase = '\\lsfile03\netdoc$\Somearns_Folder\SomearnTK_app\appscripts'
if (-not $script:AgScriptsFolder -or [string]::IsNullOrWhiteSpace($script:AgScriptsFolder)) {
    $script:AgScriptsFolder = $script:AG_TrustedBase
}

function Resolve-AgTrustedPath {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)][string]$BaseFolder,
        [Parameter(Mandatory)][string]$FileName
    )

    # ENHANCED: Use security validation if available
    if (Get-Command Assert-SecureModuleLoad -ErrorAction SilentlyContinue) {
        try {
            return Assert-SecureModuleLoad -BasePath $BaseFolder -FileName $FileName
        } catch {
            Write-SecurityLog -EventType Error -Message "Secure module load failed" -Details "$FileName : $($_.Exception.Message)"
            throw
        }
    }

    # Fallback to original validation if security helpers not loaded
    $baseResolved = (Resolve-Path -LiteralPath $BaseFolder -ErrorAction Stop).Path

    # Only allow leaf file names (no subfolders, no traversal)
    $leaf = Split-Path -Leaf $FileName
    if ($leaf -ne $FileName) { throw "Blocked module name (must be leaf filename only): $FileName" }

    $candidate = Join-Path $baseResolved $leaf
    $resolved  = (Resolve-Path -LiteralPath $candidate -ErrorAction Stop).Path

    # Ensure resolved path is under base
    if ($resolved.Length -lt $baseResolved.Length) { throw "Blocked module path: $resolved" }
    if ($resolved.Substring(0, $baseResolved.Length).ToLowerInvariant() -ne $baseResolved.ToLowerInvariant()) {
        throw "Blocked module path outside trusted base.`nBase: $baseResolved`nPath: $resolved"
    }

    # Hygiene: file size cap (prevents UI DoS via huge file)
    $fi = Get-Item -LiteralPath $resolved -ErrorAction Stop
    if ($fi.Length -gt 2MB) { throw "Blocked module (too large): $leaf ($($fi.Length) bytes)" }

    return $resolved
}

function Import-AG_TxtModuleSafe {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)][string]$FileName,
        [Parameter()][string[]]$RequiredCommands = @()
    )

    $base = $script:AgScriptsFolder
    if (-not $base -or [string]::IsNullOrWhiteSpace($base)) {
        $base = $script:AG_TrustedBase
    }

    $path = Resolve-AgTrustedPath -BaseFolder $base -FileName $FileName

    # Log module load
    if (Get-Command Write-SecurityLog -ErrorAction SilentlyContinue) {
        Write-SecurityLog -EventType Load -Message "Loading module" -Details $FileName
    }

    # Dot-source the file PATH (no ScriptBlock::Create)
    . $path

    foreach ($c in $RequiredCommands) {
        if (-not (Get-Command -Name $c -ErrorAction SilentlyContinue)) {
            throw "Module loaded but missing function: $c (from $FileName)"
        }
    }
    
    # Log successful load
    if (Get-Command Write-SecurityLog -ErrorAction SilentlyContinue) {
        Write-SecurityLog -EventType Load -Message "Module loaded successfully" -Details "$FileName (Functions: $($RequiredCommands -join ', '))"
    }
}

function _MsgErr([string]$t){ [System.Windows.Forms.MessageBox]::Show($t,'SomearnTK','OK','Error') | Out-Null }
function _MsgInfo([string]$t){ [System.Windows.Forms.MessageBox]::Show($t,'SomearnTK','OK','Information') | Out-Null }

# MENU LINK: Phone Book (Menu Button 2)
function Show-PhoneBookDirectoryView {
    [CmdletBinding()]
    param(
        [Parameter()][System.Windows.Forms.Panel]$HostPanel
    )

    try {
        if (-not $HostPanel) { throw "Host panel not available." }

        if (-not (Get-Command -Name 'Get-AG_PhoneBookDirectoryPage' -ErrorAction SilentlyContinue)) {
            Import-AG_TxtModuleSafe -FileName 'AG_PhoneBookDirectory.txt' -RequiredCommands @('Get-AG_PhoneBookDirectoryPage')
        }

        $HostPanel.SuspendLayout()
        $HostPanel.Controls.Clear()

        $dataPath = Join-Path $script:AgScriptsFolder 'PhoneBook.csv'

        $page = Get-AG_PhoneBookDirectoryPage -SetStatus {
            param($t)
            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = $t }
        } -DataPath $dataPath

        $page.Dock = 'Fill'
        [void]$HostPanel.Controls.Add($page)

        if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opened: Phone Book Directory' }

    } catch {
        _MsgErr $_.Exception.Message
        if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Phone Book failed to open.' }
    } finally {
        try { $HostPanel.ResumeLayout() } catch {}
    }
}

# MENU LINK: Site Manager (Menu Button 3)
function Show-SiteManagerView {
    [CmdletBinding()]
    param(
        [Parameter()][System.Windows.Forms.Panel]$HostPanel
    )

    try {
        if (-not $HostPanel) { throw "Host panel not available." }

        if (-not (Get-Command -Name 'Get-AG_SiteManagerPage' -ErrorAction SilentlyContinue) -and
            -not (Get-Command -Name 'Show-SiteManager'      -ErrorAction SilentlyContinue)) {

            # Prefer page-style module; allow legacy window function if that's what exists
            Import-AG_TxtModuleSafe -FileName 'AG_SiteManager.txt' -RequiredCommands @()
        }

        if (Get-Command -Name 'Get-AG_SiteManagerPage' -ErrorAction SilentlyContinue) {

            $HostPanel.SuspendLayout()
            $HostPanel.Controls.Clear()

            $dataPath = Join-Path $script:AgScriptsFolder 'SiteInformation.csv'

            $page = Get-AG_SiteManagerPage -SetStatus {
                param($t)
                if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = $t }
            } -DataPath $dataPath

            $page.Dock = 'Fill'
            [void]$HostPanel.Controls.Add($page)

            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opened: Site Manager' }
            return
        }

        if (Get-Command -Name 'Show-SiteManager' -ErrorAction SilentlyContinue) {
            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opening: Site Manager' }
            Show-SiteManager
            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opened: Site Manager (window)' }
            return
        }

        throw "Site Manager module not loaded. Missing function: Get-AG_SiteManagerPage or Show-SiteManager"

    } catch {
        _MsgErr $_.Exception.Message
        if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Site Manager failed to open.' }
    } finally {
        try { $HostPanel.ResumeLayout() } catch {}
    }
}

# MENU LINK: Application Manager (Menu Button 1)
function Show-AppGroupManagerView {
    [CmdletBinding()]
    param(
        [Parameter()][System.Windows.Forms.Panel]$HostPanel
    )

    try {
        if (-not $HostPanel) { throw "Host panel not available." }

        if (-not (Get-Command -Name 'Get-AG_AppGroupsPage' -ErrorAction SilentlyContinue) -and
            -not (Get-Command -Name 'Show-AppGroupManager' -ErrorAction SilentlyContinue)) {

            # Keep compatibility with alternate module names, but still load ONLY from trusted base
            $tryFiles = @('AG_AppGroups.txt','AG_AppGroupManager.txt','AG_AppGroupsManager.txt')
            $loaded = $false

            foreach ($fn in $tryFiles) {
                try {
                    Import-AG_TxtModuleSafe -FileName $fn -RequiredCommands @()
                    $loaded = $true
                    break
                } catch {
                    # try next name
                }
            }

            if (-not $loaded) {
                throw "Application Manager module not loaded. Tried: $($tryFiles -join ', ')"
            }
        }

        if (Get-Command -Name 'Get-AG_AppGroupsPage' -ErrorAction SilentlyContinue) {
            $HostPanel.SuspendLayout()
            $HostPanel.Controls.Clear()

            $dataPath = Join-Path $script:AgScriptsFolder 'AppGroups.csv'

            $page = Get-AG_AppGroupsPage -SetStatus {
                param($t)
                if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = $t }
            } -DataPath $dataPath

            $page.Dock = 'Fill'
            [void]$HostPanel.Controls.Add($page)

            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opened: Application Manager' }
            return
        }

        if (Get-Command -Name 'Show-AppGroupManager' -ErrorAction SilentlyContinue) {
            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opening: Application Manager' }
            Show-AppGroupManager
            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opened: Application Manager (window)' }
            return
        }

        throw "Application Manager module not loaded. Missing Get-AG_AppGroupsPage or Show-AppGroupManager."

    } catch {
        _MsgErr $_.Exception.Message
        if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Application Manager failed to open.' }
    } finally {
        try { $HostPanel.ResumeLayout() } catch {}
    }
}

# MENU LINK: Script Launcher (Menu Button 4)
function Show-ScriptLauncherView {
    [CmdletBinding()]
    param(
        [Parameter()][System.Windows.Forms.Panel]$HostPanel
    )

    try {
        if (-not $HostPanel) { throw "Host panel not available." }

        if (-not (Get-Command -Name 'Get-AG_ScriptLauncherPage' -ErrorAction SilentlyContinue)) {
            Import-AG_TxtModuleSafe -FileName 'AG_ScriptLauncherControlRoom.txt' -RequiredCommands @('Get-AG_ScriptLauncherPage')
        }

        # Hard-pin scripts listing to trusted base (reduces accidental execution from random dirs)
        $scriptsPath = $script:AG_TrustedBase

        $HostPanel.SuspendLayout()
        $HostPanel.Controls.Clear()

        $page = Get-AG_ScriptLauncherPage -SetStatus {
            param($t)
            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = $t }
        } -ScriptsPath $scriptsPath

        $page.Dock = 'Fill'
        [void]$HostPanel.Controls.Add($page)

        if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opened: Script Launcher' }

    } catch {
        _MsgErr $_.Exception.Message
        if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Script Launcher failed to open.' }
    } finally {
        try { $HostPanel.ResumeLayout() } catch {}
    }
}

# MENU LINK: Diagnostics and Repair (Menu Button 5)
function Show-DiagnosticsAndRepairView {
    [CmdletBinding()]
    param(
        [Parameter()][System.Windows.Forms.Panel]$HostPanel
    )

    try {
        if (-not $HostPanel) { throw "Host panel not available." }

        if (-not (Get-Command -Name 'Get-AG_DiagnosticsAndRepairPage' -ErrorAction SilentlyContinue)) {
            Import-AG_TxtModuleSafe -FileName 'AG_DiagnosticsAndRepair.txt' -RequiredCommands @('Get-AG_DiagnosticsAndRepairPage')
        }

        $HostPanel.SuspendLayout()
        $HostPanel.Controls.Clear()

        $page = Get-AG_DiagnosticsAndRepairPage -SetStatus {
            param($t)
            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = $t }
        }

        $page.Dock = 'Fill'
        [void]$HostPanel.Controls.Add($page)

        if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Opened: Diagnostics and Repair' }

    } catch {
        _MsgErr $_.Exception.Message
        if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = 'Diagnostics and Repair failed to open.' }
    } finally {
        try { $HostPanel.ResumeLayout() } catch {}
    }
}

function Show-MenuMain {

    if ($script:AG_MainForm -and -not $script:AG_MainForm.IsDisposed) {
        try { $script:AG_MainForm.Activate(); $script:AG_MainForm.BringToFront() } catch {}
        return
    }

    $form = New-Object System.Windows.Forms.Form
    $form.Text = 'SomearnTK'
    $form.StartPosition = 'CenterScreen'
    $form.Size = New-Object System.Drawing.Size(1400,800)
    $form.MinimumSize = New-Object System.Drawing.Size(1100,650)
    $form.BackColor = [System.Drawing.Color]::FromArgb(10,10,10)
    $form.FormBorderStyle = 'Sizable'
    $script:AG_MainForm = $form

    $rightShell = New-Object System.Windows.Forms.Panel
    $rightShell.Dock = 'Fill'
    $rightShell.BackColor = [System.Drawing.Color]::FromArgb(10,10,10)
    $rightShell.Padding = '12,10,12,10'
    $form.Controls.Add($rightShell)

    $rightHost = New-Object System.Windows.Forms.Panel
    $rightHost.Dock = 'Fill'
    $rightHost.BackColor = [System.Drawing.Color]::FromArgb(10,10,10)
    $rightShell.Controls.Add($rightHost)
    $script:AG_RightHost = $rightHost

    $left = New-Object System.Windows.Forms.Panel
    $left.Dock = 'Left'
    $left.Width = 210
    $left.MinimumSize = New-Object System.Drawing.Size(210,0)
    $left.MaximumSize = New-Object System.Drawing.Size(210,0)
    $left.BackColor = [System.Drawing.Color]::FromArgb(18,18,22)
    $form.Controls.Add($left)

    $bottom = New-Object System.Windows.Forms.Panel
    $bottom.Dock = 'Bottom'
    $bottom.Height = 30
    $bottom.BackColor = [System.Drawing.Color]::FromArgb(16,16,18)
    $bottom.Padding = '12,6,12,6'
    $form.Controls.Add($bottom)

    $status = New-Object System.Windows.Forms.Label
    $status.AutoSize = $true
    $status.Text = 'Ready.'
    $status.ForeColor = [System.Drawing.Color]::FromArgb(150,150,160)
    $status.Font = New-Object System.Drawing.Font('Segoe UI',9)
    $bottom.Controls.Add($status)
    $script:AG_StatusLabel = $status

    $top = New-Object System.Windows.Forms.Panel
    $top.Dock = 'Top'
    $top.Height = 44
    $top.BackColor = [System.Drawing.Color]::FromArgb(20,20,24)
    $form.Controls.Add($top)

    $topLabel = New-Object System.Windows.Forms.Label
    $topLabel.Text = 'Network: IDLE      IS Ops Appstack by SH'
    $topLabel.AutoSize = $true
    $topLabel.ForeColor = 'Gainsboro'
    $topLabel.Font = New-Object System.Drawing.Font('Segoe UI',9,[System.Drawing.FontStyle]::Bold)
    $topLabel.Location = New-Object System.Drawing.Point(520,13)
    $top.Controls.Add($topLabel)

    # Safe dispatch table: explicit allowlist only (removes "& $string" execution)
    $dispatch = @{
        'Show-AppGroupManagerView'       = { Show-AppGroupManagerView -HostPanel $script:AG_RightHost }
        'Show-PhoneBookDirectoryView'    = { Show-PhoneBookDirectoryView -HostPanel $script:AG_RightHost }
        'Show-SiteManagerView'           = { Show-SiteManagerView -HostPanel $script:AG_RightHost }
        'Show-ScriptLauncherView'        = { Show-ScriptLauncherView -HostPanel $script:AG_RightHost }
        'Show-DiagnosticsAndRepairView'  = { Show-DiagnosticsAndRepairView -HostPanel $script:AG_RightHost }
        '__NOTIMPL__'                    = { }
    }

    function Invoke-MenuAction([string]$name, [string]$buttonText) {
        try {
            if ([string]::IsNullOrWhiteSpace($name)) { throw "Button command is blank." }

            if ($name -eq '__NOTIMPL__') { _MsgInfo ($buttonText + ' not implemented yet.'); return }

            if (-not $dispatch.ContainsKey($name)) { throw "Blocked unknown action: $name" }

            & $dispatch[$name]

            if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = ("Opened: " + $buttonText) }

        } catch {
            _MsgErr $_.Exception.Message
        }
    }

    function New-MenuButton([string]$text, [int]$y, [string]$commandName) {
        $b = New-Object System.Windows.Forms.Button
        $b.Text = $text
        $b.SetBounds(12,$y,186,32)
        $b.FlatStyle = 'Flat'
        $b.FlatAppearance.BorderSize = 1
        $b.FlatAppearance.BorderColor = [System.Drawing.Color]::FromArgb(130,140,255)
        $b.BackColor = [System.Drawing.Color]::FromArgb(85,95,235)
        $b.ForeColor = 'White'
        $b.Font = New-Object System.Drawing.Font('Segoe UI',9.5,[System.Drawing.FontStyle]::Bold)

        $b.Tag = $commandName

        $b.Add_Click({
            Invoke-MenuAction -name ([string]$this.Tag) -buttonText ([string]$this.Text)
        })

        return $b
    }

    $y = 12
    $left.Controls.Add((New-MenuButton 'Dashboard' $y '__NOTIMPL__')); $y += 40

    $left.Controls.Add((New-MenuButton 'Application Manager' $y 'Show-AppGroupManagerView')); $y += 40
    $left.Controls.Add((New-MenuButton 'Phone Book' $y 'Show-PhoneBookDirectoryView')); $y += 40
    $left.Controls.Add((New-MenuButton 'Site Manager' $y 'Show-SiteManagerView')); $y += 40
    $left.Controls.Add((New-MenuButton 'Script Launcher' $y 'Show-ScriptLauncherView')); $y += 40
    $left.Controls.Add((New-MenuButton 'Diagnostics & Repair' $y 'Show-DiagnosticsAndRepairView')); $y += 40

    for ($i=6; $i -le 15; $i++) {
        $left.Controls.Add((New-MenuButton "Item $i" $y '__NOTIMPL__'))
        $y += 40
    }

    $btnExit = New-Object System.Windows.Forms.Button
    $btnExit.Text = 'EXIT'
    $btnExit.SetBounds(12, $left.Height - 60, 186, 44)
    $btnExit.Anchor = 'Left,Bottom'
    $btnExit.FlatStyle = 'Flat'
    $btnExit.FlatAppearance.BorderSize = 0
    $btnExit.BackColor = [System.Drawing.Color]::FromArgb(200,60,60)
    $btnExit.ForeColor = 'White'
    $btnExit.Font = New-Object System.Drawing.Font('Segoe UI',10,[System.Drawing.FontStyle]::Bold)
    $btnExit.Add_Click({ $form.Close() })
    $left.Controls.Add($btnExit)

    $form.Add_FormClosed({
        $script:AG_MainForm = $null
        $script:AG_RightHost = $null
        $script:AG_StatusLabel = $null
    })

    [void]$form.ShowDialog()
}
