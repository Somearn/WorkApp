# AG_PhoneBookDirectory.txt
# SomearnTK - Phone Book Directory (Read-only viewer, low-noise)
#
# Constraints honored:
# - PowerShell 5.1, TXT-only execution
# - No local file writes (reads CSV only; Update button opens CSV in external editor)
# - No background jobs, timers, polling, or indefinite loops
# - Auto-load runs ONCE on page open (CSV read once)
#
# Requested changes (this step):
# - Remove subtitle/verbiage line under title
# - Add bottom buttons:
#     1) Update PhoneBook  -> opens the CSV in the default editor (user saves there)
#     2) Refresh PhoneBook -> reloads CSV on demand (manual; no background)

$ErrorActionPreference = 'Stop'

Add-Type -AssemblyName System.Windows.Forms | Out-Null
Add-Type -AssemblyName System.Drawing       | Out-Null

function Show-PhoneBookDirectoryView {
    [CmdletBinding()]
    param(
        [Parameter()][System.Windows.Forms.Control]$HostPanel,
        [Parameter()][System.Windows.Forms.Control]$Parent,
        [Parameter()][System.Windows.Forms.Control]$MainPanel,
        [Parameter()][string]$DataPath
    )

    $target = $HostPanel
    if (-not $target) { $target = $Parent }
    if (-not $target) { $target = $MainPanel }

    if (-not $target) {
        [System.Windows.Forms.MessageBox]::Show("No host panel provided to embed the Phone Book view.","SomearnTK","OK","Error") | Out-Null
        return
    }

    $setStatus = {
        param([string]$t)
        try { if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = $t } } catch {}
    }

    try {
        $target.SuspendLayout()
        $target.Controls.Clear()

        $page = Get-AG_PhoneBookDirectoryPage -SetStatus $setStatus -DataPath $DataPath
        $page.Dock = 'Fill'
        [void]$target.Controls.Add($page)

    } catch {
        [System.Windows.Forms.MessageBox]::Show($_.Exception.Message,'SomearnTK','OK','Error') | Out-Null
    } finally {
        try { $target.ResumeLayout() } catch {}
    }
}

function Get-AG_PhoneBookDirectoryPage {
    [CmdletBinding()]
    param(
        [Parameter()][ScriptBlock]$SetStatus,
        [Parameter()][string]$DataPath
    )

    function _MsgErr([string]$t)  { [System.Windows.Forms.MessageBox]::Show($t,'SomearnTK','OK','Error') | Out-Null }

    # Persist status handler in script scope (safe for events)
    $script:PB_SetStatus = $SetStatus
    $script:PB_Status = {
        param([string]$t)
        if ($script:PB_SetStatus) {
            try { & $script:PB_SetStatus $t } catch {}
        }
    }

    # Resolve default CSV path (favor appdata)
    function Resolve-DefaultPhoneBookPath {
        param([string]$explicit)

        if ($explicit -and -not [string]::IsNullOrWhiteSpace($explicit)) { return $explicit }

        if ($script:AgDataFolder -and (Test-Path -LiteralPath $script:AgDataFolder)) {
            return (Join-Path $script:AgDataFolder 'PhoneBook.csv')
        }

        if ($script:AgRoot -and (Test-Path -LiteralPath $script:AgRoot)) {
            return (Join-Path $script:AgRoot 'appdata\PhoneBook.csv')
        }

        if ($script:AG_LaunchPath) {
            $root = Split-Path -LiteralPath $script:AG_LaunchPath -Parent
            return (Join-Path $root 'appdata\PhoneBook.csv')
        }

        return 'PhoneBook.csv'
    }

    $DataPath = Resolve-DefaultPhoneBookPath -explicit $DataPath

    function Resolve-PBDataPath([string]$p) {
        try {
            if (Test-Path -LiteralPath $p) { return $p }

            $folder = Split-Path -LiteralPath $p -Parent
            if (-not $folder -or -not (Test-Path -LiteralPath $folder)) { return $p }

            $candidates = @(
                (Join-Path $folder 'PhoneBook.csv'),
                (Join-Path $folder 'PhoneBookDirectory.csv'),
                (Join-Path $folder 'PhoneBook_Directory.csv'),
                (Join-Path $folder 'PB.csv')
            )
            foreach ($c in $candidates) { if (Test-Path -LiteralPath $c) { return $c } }

            $match = Get-ChildItem -LiteralPath $folder -Filter 'PhoneBook*.csv' -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($match) { return $match.FullName }

        } catch { }
        return $p
    }

    $script:PB_ResolvedDataPath = Resolve-PBDataPath $DataPath

    # Theme
    $script:PB_Theme = @{
        Form      = [System.Drawing.Color]::FromArgb(12, 14, 24)
        Panel     = [System.Drawing.Color]::FromArgb(18, 20, 34)
        Card      = [System.Drawing.Color]::FromArgb(24, 26, 46)
        Border    = [System.Drawing.Color]::FromArgb(46, 50, 86)
        Text      = [System.Drawing.Color]::FromArgb(230, 232, 246)
        Muted     = [System.Drawing.Color]::FromArgb(160, 165, 198)
        Accent    = [System.Drawing.Color]::FromArgb(160, 90, 255)
        Btn       = [System.Drawing.Color]::FromArgb(85, 95, 235)
        Btn2      = [System.Drawing.Color]::FromArgb(40, 42, 75)
    }

    $fontTitle  = New-Object System.Drawing.Font('Segoe UI', 16, [System.Drawing.FontStyle]::Bold)
    $fontBody   = New-Object System.Drawing.Font('Segoe UI', 10, [System.Drawing.FontStyle]::Regular)
    $fontSmall  = New-Object System.Drawing.Font('Segoe UI', 9,  [System.Drawing.FontStyle]::Regular)
    $fontMono   = New-Object System.Drawing.Font('Consolas', 10, [System.Drawing.FontStyle]::Regular)

    function New-CardPanel { param([int]$Pad=12)
        $p = New-Object System.Windows.Forms.Panel
        $p.BackColor = $script:PB_Theme.Card
        $p.Padding = New-Object System.Windows.Forms.Padding($Pad)
        $p.Margin  = '0,0,0,0'
        $p.Dock = 'Fill'
        $p.BorderStyle = 'FixedSingle'
        return $p
    }

    function New-ActionButton {
        param([string]$Text)

        $b = New-Object System.Windows.Forms.Button
        $b.Text = $Text
        $b.Height = 36
        $b.Width  = 180
        $b.FlatStyle = 'Flat'
        $b.FlatAppearance.BorderSize = 1
        $b.FlatAppearance.BorderColor = $script:PB_Theme.Border
        $b.BackColor = $script:PB_Theme.Btn2
        $b.ForeColor = $script:PB_Theme.Text
        $b.Font = New-Object System.Drawing.Font('Segoe UI', 9.5, [System.Drawing.FontStyle]::Bold)
        $b.Margin = '8,0,0,0'
        return $b
    }

    # State
    $script:PB_Data = @()
    $script:PB_AutoLoaded = $false
    $script:PB_FilterPending = $false

    # Root (PageRoot -> TLP)
    $PageRoot = New-Object System.Windows.Forms.Panel
    $PageRoot.Dock = 'Fill'
    $PageRoot.BackColor = $script:PB_Theme.Form

    $TLP = New-Object System.Windows.Forms.TableLayoutPanel
    $TLP.Dock = 'Fill'
    $TLP.BackColor = $script:PB_Theme.Form
    $TLP.ColumnCount = 1
    $TLP.RowCount = 3
    $TLP.Padding = '14,12,14,12'
    $TLP.RowStyles.Clear()
    [void]$TLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute, 56)))
    [void]$TLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::AutoSize)))
    [void]$TLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Percent, 100)))
    [void]$PageRoot.Controls.Add($TLP)

    # Header row
    $Header = New-Object System.Windows.Forms.Panel
    $Header.Dock = 'Fill'
    $Header.BackColor = $script:PB_Theme.Form

    $lblTitle = New-Object System.Windows.Forms.Label
    $lblTitle.Text = 'Phone Book Directory'
    $lblTitle.Font = $fontTitle
    $lblTitle.ForeColor = $script:PB_Theme.Text
    $lblTitle.AutoSize = $true
    $lblTitle.Location = New-Object System.Drawing.Point(0,10)

    [void]$Header.Controls.Add($lblTitle)
    [void]$TLP.Controls.Add($Header, 0, 0)

    # Filters row
    $Filters = New-Object System.Windows.Forms.Panel
    $Filters.Dock = 'Top'
    $Filters.BackColor = $script:PB_Theme.Form
    $Filters.Padding = '0,10,0,10'
    $Filters.AutoSize = $true
    $Filters.AutoSizeMode = 'GrowAndShrink'

    $FiltersTLP = New-Object System.Windows.Forms.TableLayoutPanel
    $FiltersTLP.Dock = 'Top'
    $FiltersTLP.BackColor = $script:PB_Theme.Form
    $FiltersTLP.AutoSize = $true
    $FiltersTLP.AutoSizeMode = 'GrowAndShrink'
    $FiltersTLP.ColumnCount = 4
    $FiltersTLP.RowCount = 2
    $FiltersTLP.ColumnStyles.Clear()
    [void]$FiltersTLP.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute, 120)))
    [void]$FiltersTLP.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent, 50)))
    [void]$FiltersTLP.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute, 140)))
    [void]$FiltersTLP.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent, 50)))
    $FiltersTLP.RowStyles.Clear()
    [void]$FiltersTLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::AutoSize)))
    [void]$FiltersTLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::AutoSize)))

    $lblName = New-Object System.Windows.Forms.Label
    $lblName.Text = 'Name Search'
    $lblName.ForeColor = $script:PB_Theme.Muted
    $lblName.Font = $fontBody
    $lblName.AutoSize = $true
    $lblName.Margin = '0,8,0,0'

    $txtName = New-Object System.Windows.Forms.TextBox
    $txtName.Font = $fontBody
    $txtName.BackColor = $script:PB_Theme.Panel
    $txtName.ForeColor = $script:PB_Theme.Text
    $txtName.BorderStyle = 'FixedSingle'
    $txtName.Dock = 'Fill'
    $txtName.Margin = '0,6,10,0'

    $lblSupports = New-Object System.Windows.Forms.Label
    $lblSupports.Text = 'Supports Search'
    $lblSupports.ForeColor = $script:PB_Theme.Muted
    $lblSupports.Font = $fontBody
    $lblSupports.AutoSize = $true
    $lblSupports.Margin = '0,8,0,0'

    $txtSupports = New-Object System.Windows.Forms.TextBox
    $txtSupports.Font = $fontBody
    $txtSupports.BackColor = $script:PB_Theme.Panel
    $txtSupports.ForeColor = $script:PB_Theme.Text
    $txtSupports.BorderStyle = 'FixedSingle'
    $txtSupports.Dock = 'Fill'
    $txtSupports.Margin = '0,6,0,0'

    $lblHint = New-Object System.Windows.Forms.Label
    $lblHint.Text = 'Tip: filters as you type (local only).'
    $lblHint.ForeColor = $script:PB_Theme.Muted
    $lblHint.Font = $fontSmall
    $lblHint.AutoSize = $true
    $lblHint.Margin = '0,8,0,0'

    $lblCount = New-Object System.Windows.Forms.Label
    $lblCount.Text = '0 contacts'
    $lblCount.ForeColor = $script:PB_Theme.Accent
    $lblCount.Font = $fontSmall
    $lblCount.AutoSize = $true
    $lblCount.Margin = '0,8,0,0'
    $lblCount.TextAlign = 'MiddleRight'
    $lblCount.Dock = 'Right'

    [void]$FiltersTLP.Controls.Add($lblName, 0, 0)
    [void]$FiltersTLP.Controls.Add($txtName, 1, 0)
    [void]$FiltersTLP.Controls.Add($lblSupports, 2, 0)
    [void]$FiltersTLP.Controls.Add($txtSupports, 3, 0)
    [void]$FiltersTLP.Controls.Add($lblHint, 0, 1)
    $FiltersTLP.SetColumnSpan($lblHint, 3)
    [void]$FiltersTLP.Controls.Add($lblCount, 3, 1)

    [void]$Filters.Controls.Add($FiltersTLP)
    [void]$TLP.Controls.Add($Filters, 0, 1)

    # Content row with a bottom action bar inside (no header buttons per request)
    $ContentHost = New-Object System.Windows.Forms.Panel
    $ContentHost.Dock = 'Fill'
    $ContentHost.BackColor = $script:PB_Theme.Form

    $ContentOuter = New-Object System.Windows.Forms.TableLayoutPanel
    $ContentOuter.Dock = 'Fill'
    $ContentOuter.BackColor = $script:PB_Theme.Form
    $ContentOuter.ColumnCount = 1
    $ContentOuter.RowCount = 2
    $ContentOuter.RowStyles.Clear()
    [void]$ContentOuter.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Percent, 100)))
    [void]$ContentOuter.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute, 52)))
    [void]$ContentHost.Controls.Add($ContentOuter)

    # Main content (left list + right details)
    $ContentTLP = New-Object System.Windows.Forms.TableLayoutPanel
    $ContentTLP.Dock = 'Fill'
    $ContentTLP.BackColor = $script:PB_Theme.Form
    $ContentTLP.ColumnCount = 2
    $ContentTLP.RowCount = 1
    $ContentTLP.ColumnStyles.Clear()
    [void]$ContentTLP.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute, 520)))
    [void]$ContentTLP.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent, 100)))

    # Left: Names list only
    $LeftCard = New-CardPanel -Pad 12
    $lbNames = New-Object System.Windows.Forms.ListBox
    $lbNames.Dock = 'Fill'
    $lbNames.Font = $fontBody
    $lbNames.BackColor = $script:PB_Theme.Panel
    $lbNames.ForeColor = $script:PB_Theme.Text
    $lbNames.BorderStyle = 'FixedSingle'
    $lbNames.IntegralHeight = $false
    [void]$LeftCard.Controls.Add($lbNames)

    # Right: Details
    $RightCard = New-CardPanel -Pad 14
    $RightTLP = New-Object System.Windows.Forms.TableLayoutPanel
    $RightTLP.Dock = 'Fill'
    $RightTLP.BackColor = $script:PB_Theme.Card
    $RightTLP.ColumnCount = 1
    $RightTLP.RowCount = 3
    $RightTLP.RowStyles.Clear()
    [void]$RightTLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute, 34)))
    [void]$RightTLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::AutoSize)))
    [void]$RightTLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Percent, 100)))
    [void]$RightCard.Controls.Add($RightTLP)

    $lblDetailHdr = New-Object System.Windows.Forms.Label
    $lblDetailHdr.Text = 'Contact Details'
    $lblDetailHdr.Font = New-Object System.Drawing.Font('Segoe UI', 12, [System.Drawing.FontStyle]::Bold)
    $lblDetailHdr.ForeColor = $script:PB_Theme.Text
    $lblDetailHdr.AutoSize = $true
    $lblDetailHdr.Margin = '0,0,0,8'

    $lblSelected = New-Object System.Windows.Forms.Label
    $lblSelected.Text = 'Select a name on the left.'
    $lblSelected.Font = $fontBody
    $lblSelected.ForeColor = $script:PB_Theme.Muted
    $lblSelected.AutoSize = $true
    $lblSelected.Margin = '0,0,0,10'

    $rtbDetails = New-Object System.Windows.Forms.RichTextBox
    $rtbDetails.Dock = 'Fill'
    $rtbDetails.ReadOnly = $true
    $rtbDetails.BorderStyle = 'FixedSingle'
    $rtbDetails.BackColor = $script:PB_Theme.Panel
    $rtbDetails.ForeColor = $script:PB_Theme.Text
    $rtbDetails.Font = $fontMono
    $rtbDetails.DetectUrls = $true
    $rtbDetails.WordWrap = $false

    [void]$RightTLP.Controls.Add($lblDetailHdr, 0, 0)
    [void]$RightTLP.Controls.Add($lblSelected, 0, 1)
    [void]$RightTLP.Controls.Add($rtbDetails, 0, 2)

    [void]$ContentTLP.Controls.Add($LeftCard, 0, 0)
    [void]$ContentTLP.Controls.Add($RightCard, 1, 0)

    [void]$ContentOuter.Controls.Add($ContentTLP, 0, 0)

    # Bottom action bar (right-aligned)
    $ActionBar = New-Object System.Windows.Forms.Panel
    $ActionBar.Dock = 'Fill'
    $ActionBar.BackColor = $script:PB_Theme.Form
    $ActionBar.Padding = '0,8,0,0'

    $ActionFlow = New-Object System.Windows.Forms.FlowLayoutPanel
    $ActionFlow.Dock = 'Right'
    $ActionFlow.FlowDirection = 'RightToLeft'
    $ActionFlow.WrapContents = $false
    $ActionFlow.AutoSize = $true
    $ActionFlow.BackColor = $script:PB_Theme.Form

    $btnRefresh = New-ActionButton -Text 'Refresh PhoneBook'
    $btnUpdate  = New-ActionButton -Text 'Update PhoneBook'

    [void]$ActionFlow.Controls.Add($btnRefresh)
    [void]$ActionFlow.Controls.Add($btnUpdate)

    [void]$ActionBar.Controls.Add($ActionFlow)
    [void]$ContentOuter.Controls.Add($ActionBar, 0, 1)

    [void]$TLP.Controls.Add($ContentHost, 0, 2)

    # UI refs
    $script:PB_UI = @{
        LbNames     = $lbNames
        TxtName     = $txtName
        TxtSupports = $txtSupports
        LblCount    = $lblCount
        LblSelected = $lblSelected
        RtbDetails  = $rtbDetails
        PageRoot    = $PageRoot
        BtnRefresh  = $btnRefresh
        BtnUpdate   = $btnUpdate
    }

    # Data mapping helpers
    $script:PB_GetFieldValue = {
        param($obj, [string[]]$names)
        foreach ($n in $names) {
            if ($obj.PSObject.Properties.Name -contains $n) {
                $v = $obj.$n
                if ($null -ne $v -and -not [string]::IsNullOrWhiteSpace([string]$v)) { return [string]$v }
            }
        }
        return ''
    }

    $script:PB_NormalizeRow = {
        param($row)

        $name = & $script:PB_GetFieldValue $row @('Name','Primary','FullName','DisplayName')
        $team = & $script:PB_GetFieldValue $row @('Team','Title','Role')

        $iv1   = & $script:PB_GetFieldValue $row @('Phone Number loaded from Ivanti Primary','IvantiPrimary','Ivanti Primary','IvantiPrimaryPhone','Primary PI Backup','Primary Phone')
        $iv2   = & $script:PB_GetFieldValue $row @('Phone Number Loaded from Ivanti Secondary','IvantiSecondary','Ivanti Secondary','IvantiSecondaryPhone','Backup Phone','Secondary Phone','Backup')
        $staff = & $script:PB_GetFieldValue $row @('Phone Number loaded from Staff Directory','StaffDirectory','Staff Directory','StaffDirectoryPhone')

        $supports = & $script:PB_GetFieldValue $row @('Supports','Support','Team Supports','Area')
        $details  = & $script:PB_GetFieldValue $row @('More details','MoreDetails','Details','Notes','Info')

        $mgr = & $script:PB_GetFieldValue $row @('Manager','Mgr')
        $dir = & $script:PB_GetFieldValue $row @('Director','Dir')
        $vp  = & $script:PB_GetFieldValue $row @('VP','Vice President','V.P.')
        $sd  = & $script:PB_GetFieldValue $row @('StartDate','Start Date')
        $ed  = & $script:PB_GetFieldValue $row @('EndDate','End Date')

        [pscustomobject]@{
            Name            = $name
            Team            = $team
            IvantiPrimary   = $iv1
            IvantiSecondary = $iv2
            StaffDirectory  = $staff
            Supports        = $supports
            Details         = $details
            Manager         = $mgr
            Director        = $dir
            VP              = $vp
            StartDate       = $sd
            EndDate         = $ed
            Raw             = $row
        }
    }

    $script:PB_RenderDetailsByName = {
        param([string]$name)

        if (-not $script:PB_Data -or $script:PB_Data.Count -eq 0) { return }
        $match = $script:PB_Data | Where-Object { $_.Name -eq $name } | Select-Object -First 1
        if (-not $match) { return }

        $lines = New-Object System.Collections.Generic.List[string]
        [void]$lines.Add(("Name                 : {0}" -f $match.Name))
        if ($match.Team) { [void]$lines.Add(("Team                 : {0}" -f $match.Team)) }

        if ($match.IvantiPrimary)   { [void]$lines.Add(("Ivanti Primary       : {0}" -f $match.IvantiPrimary)) }
        if ($match.IvantiSecondary) { [void]$lines.Add(("Ivanti Secondary     : {0}" -f $match.IvantiSecondary)) }
        if ($match.StaffDirectory)  { [void]$lines.Add(("Staff Directory      : {0}" -f $match.StaffDirectory)) }

        if ($match.Manager)  { [void]$lines.Add(("Manager              : {0}" -f $match.Manager)) }
        if ($match.Director) { [void]$lines.Add(("Director             : {0}" -f $match.Director)) }
        if ($match.VP)       { [void]$lines.Add(("VP                   : {0}" -f $match.VP)) }
        if ($match.StartDate){ [void]$lines.Add(("StartDate            : {0}" -f $match.StartDate)) }
        if ($match.EndDate)  { [void]$lines.Add(("EndDate              : {0}" -f $match.EndDate)) }

        if ($match.Supports) { [void]$lines.Add(("Supports             : {0}" -f $match.Supports)) }

        [void]$lines.Add('')
        if ($match.Details) { [void]$lines.Add('More details:'); [void]$lines.Add($match.Details) }
        else { [void]$lines.Add('More details: (none)') }

        $script:PB_UI.LblSelected.Text = $match.Name
        $script:PB_UI.RtbDetails.Text  = ($lines -join "`r`n")
    }

    $script:PB_ApplyFilter = {
        if (-not $script:PB_UI -or -not $script:PB_UI.LbNames) { return }

        $lb = $script:PB_UI.LbNames
        $lb.BeginUpdate()
        try {
            $lb.Items.Clear()
            $script:PB_UI.LblSelected.Text = 'Select a name on the left.'
            $script:PB_UI.RtbDetails.Clear()

            if (-not $script:PB_Data -or $script:PB_Data.Count -eq 0) { $script:PB_UI.LblCount.Text = '0 contacts'; return }

            $nameQ  = $script:PB_UI.TxtName.Text.Trim()
            $supQ   = $script:PB_UI.TxtSupports.Text.Trim()

            $filtered = New-Object System.Collections.Generic.List[object]
            foreach ($c in $script:PB_Data) {
                if ([string]::IsNullOrWhiteSpace($c.Name)) { continue }

                if ($nameQ.Length -gt 0) {
                    if ($c.Name -notlike "*$nameQ*") { continue }
                }

                if ($supQ.Length -gt 0) {
                    $hay = ($c.Supports + ' ' + $c.Details + ' ' + $c.Team + ' ' + $c.Manager + ' ' + $c.Director + ' ' + $c.VP)
                    if ($hay -notlike "*$supQ*") { continue }
                }

                [void]$filtered.Add($c)
            }

            $sorted = $filtered | Sort-Object -Property Name
            foreach ($c in $sorted) { [void]$lb.Items.Add($c.Name) }

            $script:PB_UI.LblCount.Text = "{0} contacts" -f ($lb.Items.Count)
            if ($script:PB_Status) { & $script:PB_Status ("PhoneBook: {0} shown" -f $lb.Items.Count) }

        } finally { $lb.EndUpdate() }
    }

    # Type-ahead coalescing (no timers)
    $script:PB_QueueFilter = {
        if ($script:PB_FilterPending) { return }
        $script:PB_FilterPending = $true
        try {
            $null = $script:PB_UI.PageRoot.BeginInvoke([System.Action]{
                $script:PB_FilterPending = $false
                try { & $script:PB_ApplyFilter } catch { }
            })
        } catch {
            $script:PB_FilterPending = $false
            try { & $script:PB_ApplyFilter } catch { }
        }
    }

    $script:PB_LoadData = {
        param([switch]$Auto)

        try {
            $script:PB_ResolvedDataPath = Resolve-PBDataPath $script:PB_ResolvedDataPath

            if (-not (Test-Path -LiteralPath $script:PB_ResolvedDataPath)) {
                if ($script:PB_Status) { & $script:PB_Status ("PhoneBook: CSV not found ({0})" -f $script:PB_ResolvedDataPath) }
                return
            }

            if ($script:PB_Status) { & $script:PB_Status "Loading directory..." }
            $script:PB_UI.PageRoot.Cursor = 'WaitCursor'
            [System.Windows.Forms.Application]::DoEvents()

            $raw = Import-Csv -LiteralPath $script:PB_ResolvedDataPath

            $norm = New-Object System.Collections.Generic.List[object]
            foreach ($r in $raw) {
                $n = & $script:PB_NormalizeRow $r
                if (-not [string]::IsNullOrWhiteSpace($n.Name)) { [void]$norm.Add($n) }
            }

            $script:PB_Data = $norm.ToArray()
            & $script:PB_ApplyFilter

            if ($script:PB_Status) {
                if ($Auto) { & $script:PB_Status ("Loaded {0} contacts" -f $script:PB_Data.Count) }
                else { & $script:PB_Status ("Refreshed: {0} contacts" -f $script:PB_Data.Count) }
            }

        } catch {
            _MsgErr ("Load failed:`r`n{0}" -f $_.Exception.Message)
            if ($script:PB_Status) { & $script:PB_Status "Load failed." }
        } finally {
            try { $script:PB_UI.PageRoot.Cursor = 'Default' } catch {}
        }
    }

    function Open-PhoneBookForEdit {
        param([string]$path)

        try {
            if (-not (Test-Path -LiteralPath $path)) {
                _MsgErr ("CSV not found:`r`n{0}" -f $path)
                return
            }

            if ($script:PB_Status) { & $script:PB_Status "Opening PhoneBook CSV for edit..." }

            # Try default app
            try {
                Start-Process -FilePath $path | Out-Null
                return
            } catch { }

            # Fallback: open Explorer with file selected
            try {
                Start-Process -FilePath 'explorer.exe' -ArgumentList @('/select,', $path) | Out-Null
                return
            } catch { }

            _MsgErr "Could not launch an editor for the CSV on this workstation."

        } catch {
            _MsgErr ("Open failed:`r`n{0}" -f $_.Exception.Message)
        }
    }

    # Events
    $txtName.Add_TextChanged({ try { if ($script:PB_QueueFilter) { & $script:PB_QueueFilter } } catch {} }) | Out-Null
    $txtSupports.Add_TextChanged({ try { if ($script:PB_QueueFilter) { & $script:PB_QueueFilter } } catch {} }) | Out-Null

    $lbNames.Add_SelectedIndexChanged({
        try {
            if ($script:PB_UI.LbNames.SelectedItem) {
                & $script:PB_RenderDetailsByName ([string]$script:PB_UI.LbNames.SelectedItem)
            }
        } catch {
            _MsgErr ("Selection failed:`r`n{0}" -f $_.Exception.Message)
        }
    }) | Out-Null

    $script:PB_UI.BtnRefresh.Add_Click({
        try { & $script:PB_LoadData } catch { _MsgErr $_.Exception.Message }
    }) | Out-Null

    $script:PB_UI.BtnUpdate.Add_Click({
        Open-PhoneBookForEdit -path $script:PB_ResolvedDataPath
    }) | Out-Null

    if ($script:PB_Status) { & $script:PB_Status "PhoneBook page opened. Auto-loading directory once..." }

    # Auto-load once, after control is visible
    if (-not $script:PB_AutoLoaded) {
        $script:PB_AutoLoaded = $true
        try {
            $null = $PageRoot.BeginInvoke([System.Action]{
                try { & $script:PB_LoadData -Auto } catch { }
            })
        } catch {
            try { & $script:PB_LoadData -Auto } catch { }
        }
    }

    return $PageRoot
}
