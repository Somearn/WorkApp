# AG_DiagnosticsAndRepair.txt
# SomearnTK - Diagnostics and Repair (Star Trek Theme)
#
# Constraints:
# - PowerShell 5.1, TXT-only execution
# - No local file writes
# - No background jobs, timers, polling, or indefinite loops
# - No network noise unless explicitly triggered by user button click
# - Tools run in external terminal windows (max 2 concurrent)
# - Least privilege approach - check access before prompting for credentials
#
# Features:
# - Star Trek themed UI with futuristic button styles
# - Diagnostic tools menu with hostname input
# - External terminal execution
# - Feature request box in right corner
# - Window management (close old terminals before opening new)

$ErrorActionPreference = 'Stop'

Add-Type -AssemblyName System.Windows.Forms | Out-Null
Add-Type -AssemblyName System.Drawing       | Out-Null
Add-Type -AssemblyName Microsoft.VisualBasic | Out-Null

# Track running terminal processes (max 2)
$script:DR_RunningTerminals = [System.Collections.ArrayList]::new()

function Show-DiagnosticsAndRepairView {
    [CmdletBinding()]
    param(
        [Parameter()][System.Windows.Forms.Control]$HostPanel,
        [Parameter()][System.Windows.Forms.Control]$Parent,
        [Parameter()][System.Windows.Forms.Control]$MainPanel
    )

    $target = $HostPanel
    if (-not $target) { $target = $Parent }
    if (-not $target) { $target = $MainPanel }

    if (-not $target) {
        [System.Windows.Forms.MessageBox]::Show("No host panel provided.","SomearnTK","OK","Error") | Out-Null
        return
    }

    $setStatus = {
        param([string]$t)
        try { if ($script:AG_StatusLabel) { $script:AG_StatusLabel.Text = $t } } catch {}
    }

    try {
        $target.SuspendLayout()
        $target.Controls.Clear()

        $page = Get-AG_DiagnosticsAndRepairPage -SetStatus $setStatus
        $page.Dock = 'Fill'
        [void]$target.Controls.Add($page)

    } catch {
        [System.Windows.Forms.MessageBox]::Show($_.Exception.Message,'SomearnTK','OK','Error') | Out-Null
    } finally {
        try { $target.ResumeLayout() } catch {}
    }
}

function Get-AG_DiagnosticsAndRepairPage {
    [CmdletBinding()]
    param(
        [Parameter()][ScriptBlock]$SetStatus
    )

    function _MsgErr([string]$t)  { [System.Windows.Forms.MessageBox]::Show($t,'SomearnTK','OK','Error') | Out-Null }
    function _MsgInfo([string]$t) { [System.Windows.Forms.MessageBox]::Show($t,'SomearnTK','OK','Information') | Out-Null }

    # Persist status handler
    $script:DR_SetStatus = $SetStatus
    $script:DR_Status = {
        param([string]$t)
        if ($script:DR_SetStatus) {
            try { & $script:DR_SetStatus $t } catch {}
        }
    }

    # Star Trek Theme Colors (based on reference image - futuristic, vibrant)
    $script:DR_Theme = @{
        Background    = [System.Drawing.Color]::FromArgb(15, 15, 35)        # Deep space blue-black
        Panel         = [System.Drawing.Color]::FromArgb(20, 25, 50)        # Dark panel blue
        PanelLight    = [System.Drawing.Color]::FromArgb(30, 40, 70)        # Lighter panel
        
        # Button colors inspired by Star Trek LCARS and reference image
        BtnOrange     = [System.Drawing.Color]::FromArgb(255, 145, 40)      # Orange/amber
        BtnBlue       = [System.Drawing.Color]::FromArgb(90, 180, 255)      # Cyan blue
        BtnPurple     = [System.Drawing.Color]::FromArgb(200, 100, 255)     # Purple/magenta
        BtnGreen      = [System.Drawing.Color]::FromArgb(100, 255, 150)     # Green
        BtnRed        = [System.Drawing.Color]::FromArgb(255, 80, 100)      # Red/pink
        BtnYellow     = [System.Drawing.Color]::FromArgb(255, 200, 50)      # Yellow
        BtnTeal       = [System.Drawing.Color]::FromArgb(80, 220, 220)      # Teal/cyan
        
        Text          = [System.Drawing.Color]::FromArgb(220, 230, 255)     # Light blue-white
        TextDark      = [System.Drawing.Color]::FromArgb(30, 40, 70)        # Dark text for light buttons
        Accent        = [System.Drawing.Color]::FromArgb(90, 180, 255)      # Accent cyan
        Border        = [System.Drawing.Color]::FromArgb(90, 180, 255)      # Border cyan
        Glow          = [System.Drawing.Color]::FromArgb(120, 200, 255)     # Glow effect
    }

    # Fonts - Star Trek style (clean, futuristic)
    $fontTitle  = New-Object System.Drawing.Font('Segoe UI', 18, [System.Drawing.FontStyle]::Bold)
    $fontBtn    = New-Object System.Drawing.Font('Segoe UI', 11, [System.Drawing.FontStyle]::Bold)
    $fontBody   = New-Object System.Drawing.Font('Segoe UI', 10, [System.Drawing.FontStyle]::Regular)
    $fontSmall  = New-Object System.Drawing.Font('Segoe UI', 9, [System.Drawing.FontStyle]::Regular)

    # Window management helper
    function Manage-TerminalWindows {
        # Clean up any terminated processes
        $toRemove = @()
        foreach ($proc in $script:DR_RunningTerminals) {
            if ($proc.HasExited) {
                $toRemove += $proc
            }
        }
        foreach ($proc in $toRemove) {
            [void]$script:DR_RunningTerminals.Remove($proc)
        }

        # If we have 2 or more running, close the oldest ones
        while ($script:DR_RunningTerminals.Count -ge 2) {
            $oldest = $script:DR_RunningTerminals[0]
            try {
                if (-not $oldest.HasExited) {
                    $oldest.Kill()
                }
            } catch { }
            [void]$script:DR_RunningTerminals.RemoveAt(0)
        }
    }

    # Execute tool in external PowerShell window
    function Invoke-DiagnosticTool {
        param(
            [string]$ToolName,
            [string]$Command,
            [bool]$RequiresTarget = $false
        )

        try {
            # Get target if needed
            $target = 'localhost'
            if ($RequiresTarget) {
                $target = [Microsoft.VisualBasic.Interaction]::InputBox(
                    "Enter hostname or IP address:", 
                    "$ToolName - Target", 
                    "localhost"
                )
                if ([string]::IsNullOrWhiteSpace($target)) {
                    & $script:DR_Status "$ToolName - Cancelled"
                    return
                }
            }

            # Replace TARGET placeholder in command
            $finalCommand = $Command -replace '\{TARGET\}', $target

            # Check if we need elevated privileges (basic check)
            $needsElevation = $false
            if ($finalCommand -match '(Get-Service|Get-WmiObject|Get-EventLog|Restart-Computer|Stop-Computer)') {
                $currentPrincipal = New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())
                $needsElevation = -not $currentPrincipal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
            }

            # Manage existing terminal windows
            Manage-TerminalWindows

            # Build PowerShell command
            $psCommand = @"
Write-Host '═══════════════════════════════════════════════════════════' -ForegroundColor Cyan
Write-Host ' DIAGNOSTICS AND REPAIR - $ToolName' -ForegroundColor Yellow
Write-Host '═══════════════════════════════════════════════════════════' -ForegroundColor Cyan
Write-Host ''
Write-Host 'Target: $target' -ForegroundColor Green
Write-Host 'Time: ' -NoNewline; Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
Write-Host ''
Write-Host '───────────────────────────────────────────────────────────' -ForegroundColor Cyan
Write-Host ''

try {
    $finalCommand
} catch {
    Write-Host ''
    Write-Host 'ERROR: ' -ForegroundColor Red -NoNewline
    Write-Host `$_.Exception.Message -ForegroundColor Yellow
}

Write-Host ''
Write-Host '───────────────────────────────────────────────────────────' -ForegroundColor Cyan
Write-Host 'Press any key to close...' -ForegroundColor Gray
`$null = `$Host.UI.RawUI.ReadKey('NoEcho,IncludeKeyDown')
"@

            # Encode command for command line
            $bytes = [System.Text.Encoding]::Unicode.GetBytes($psCommand)
            $encodedCommand = [Convert]::ToBase64String($bytes)

            # Start PowerShell window
            $psi = New-Object System.Diagnostics.ProcessStartInfo
            $psi.FileName = "powershell.exe"
            
            if ($needsElevation) {
                $psi.Verb = "runas"
                $psi.Arguments = "-NoExit -EncodedCommand $encodedCommand"
                & $script:DR_Status "$ToolName - Requesting elevated privileges..."
            } else {
                $psi.Arguments = "-NoExit -EncodedCommand $encodedCommand"
            }

            $psi.UseShellExecute = $true
            $psi.WindowStyle = 'Normal'

            $process = [System.Diagnostics.Process]::Start($psi)
            if ($process) {
                [void]$script:DR_RunningTerminals.Add($process)
                & $script:DR_Status "$ToolName - Launched in external terminal"
            }

        } catch {
            _MsgErr "Failed to launch $ToolName : $($_.Exception.Message)"
            & $script:DR_Status "$ToolName - Failed"
        }
    }

    # Create Star Trek style button
    function New-StarTrekButton {
        param(
            [string]$Text,
            [System.Drawing.Color]$BackColor,
            [int]$Width = 280,
            [int]$Height = 60
        )

        $btn = New-Object System.Windows.Forms.Button
        $btn.Text = $Text
        $btn.Width = $Width
        $btn.Height = $Height
        $btn.FlatStyle = 'Flat'
        $btn.BackColor = $BackColor
        
        # Determine text color based on button brightness
        $brightness = ($BackColor.R * 0.299) + ($BackColor.G * 0.587) + ($BackColor.B * 0.114)
        if ($brightness -gt 186) {
            $btn.ForeColor = $script:DR_Theme.TextDark
        } else {
            $btn.ForeColor = $script:DR_Theme.Text
        }
        
        $btn.Font = $fontBtn
        $btn.FlatAppearance.BorderSize = 2
        $btn.FlatAppearance.BorderColor = $script:DR_Theme.Border
        $btn.Margin = '10,10,10,10'
        $btn.Cursor = 'Hand'
        
        # Add hover effect
        $btn.Add_MouseEnter({
            $this.FlatAppearance.BorderColor = $script:DR_Theme.Glow
        })
        $btn.Add_MouseLeave({
            $this.FlatAppearance.BorderColor = $script:DR_Theme.Border
        })

        return $btn
    }

    # Root Panel
    $PageRoot = New-Object System.Windows.Forms.Panel
    $PageRoot.Dock = 'Fill'
    $PageRoot.BackColor = $script:DR_Theme.Background

    $TLP = New-Object System.Windows.Forms.TableLayoutPanel
    $TLP.Dock = 'Fill'
    $TLP.BackColor = $script:DR_Theme.Background
    $TLP.ColumnCount = 1
    $TLP.RowCount = 2
    $TLP.Padding = '20,20,20,20'
    $TLP.RowStyles.Clear()
    [void]$TLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute, 80)))
    [void]$TLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Percent, 100)))
    [void]$PageRoot.Controls.Add($TLP)

    # Header
    $Header = New-Object System.Windows.Forms.Panel
    $Header.Dock = 'Fill'
    $Header.BackColor = $script:DR_Theme.Background

    $lblTitle = New-Object System.Windows.Forms.Label
    $lblTitle.Text = 'DIAGNOSTICS AND REPAIR'
    $lblTitle.Font = $fontTitle
    $lblTitle.ForeColor = $script:DR_Theme.Accent
    $lblTitle.AutoSize = $true
    $lblTitle.Location = New-Object System.Drawing.Point(0, 15)

    [void]$Header.Controls.Add($lblTitle)
    [void]$TLP.Controls.Add($Header, 0, 0)

    # Main Content Area
    $ContentHost = New-Object System.Windows.Forms.Panel
    $ContentHost.Dock = 'Fill'
    $ContentHost.BackColor = $script:DR_Theme.Background

    # Split: Left (buttons) | Right (feature request box)
    $ContentSplit = New-Object System.Windows.Forms.TableLayoutPanel
    $ContentSplit.Dock = 'Fill'
    $ContentSplit.BackColor = $script:DR_Theme.Background
    $ContentSplit.ColumnCount = 2
    $ContentSplit.RowCount = 1
    $ContentSplit.ColumnStyles.Clear()
    [void]$ContentSplit.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent, 75)))
    [void]$ContentSplit.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent, 25)))
    [void]$ContentHost.Controls.Add($ContentSplit)
    [void]$TLP.Controls.Add($ContentHost, 0, 1)

    # LEFT: Button Grid Panel
    $ButtonPanel = New-Object System.Windows.Forms.Panel
    $ButtonPanel.Dock = 'Fill'
    $ButtonPanel.BackColor = $script:DR_Theme.Panel
    $ButtonPanel.Padding = '20,20,20,20'
    $ButtonPanel.AutoScroll = $true

    $ButtonFlow = New-Object System.Windows.Forms.FlowLayoutPanel
    $ButtonFlow.Dock = 'Fill'
    $ButtonFlow.FlowDirection = 'LeftToRight'
    $ButtonFlow.WrapContents = $true
    $ButtonFlow.BackColor = $script:DR_Theme.Panel
    $ButtonFlow.Padding = '10,10,10,10'
    $ButtonFlow.AutoScroll = $true

    [void]$ButtonPanel.Controls.Add($ButtonFlow)
    [void]$ContentSplit.Controls.Add($ButtonPanel, 0, 0)

    # RIGHT: Feature Request Box
    $RequestPanel = New-Object System.Windows.Forms.Panel
    $RequestPanel.Dock = 'Fill'
    $RequestPanel.BackColor = $script:DR_Theme.PanelLight
    $RequestPanel.Padding = '15,15,15,15'

    $RequestTLP = New-Object System.Windows.Forms.TableLayoutPanel
    $RequestTLP.Dock = 'Fill'
    $RequestTLP.BackColor = $script:DR_Theme.PanelLight
    $RequestTLP.ColumnCount = 1
    $RequestTLP.RowCount = 3
    $RequestTLP.RowStyles.Clear()
    [void]$RequestTLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute, 40)))
    [void]$RequestTLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Percent, 100)))
    [void]$RequestTLP.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute, 50)))
    [void]$RequestPanel.Controls.Add($RequestTLP)

    $lblRequestTitle = New-Object System.Windows.Forms.Label
    $lblRequestTitle.Text = 'FEATURE REQUESTS'
    $lblRequestTitle.Font = New-Object System.Drawing.Font('Segoe UI', 11, [System.Drawing.FontStyle]::Bold)
    $lblRequestTitle.ForeColor = $script:DR_Theme.Accent
    $lblRequestTitle.Dock = 'Fill'
    $lblRequestTitle.TextAlign = 'MiddleCenter'
    [void]$RequestTLP.Controls.Add($lblRequestTitle, 0, 0)

    $txtRequest = New-Object System.Windows.Forms.TextBox
    $txtRequest.Multiline = $true
    $txtRequest.ScrollBars = 'Vertical'
    $txtRequest.Font = $fontBody
    $txtRequest.BackColor = $script:DR_Theme.Background
    $txtRequest.ForeColor = $script:DR_Theme.Text
    $txtRequest.BorderStyle = 'FixedSingle'
    $txtRequest.Dock = 'Fill'
    $txtRequest.Text = "Enter feature requests here...`r`n`r`nExamples:`r`n- Add DNS flush tool`r`n- Add port scanner`r`n- Add bandwidth test"
    [void]$RequestTLP.Controls.Add($txtRequest, 0, 1)

    $btnSubmitRequest = New-Object System.Windows.Forms.Button
    $btnSubmitRequest.Text = 'Submit Request'
    $btnSubmitRequest.Dock = 'Fill'
    $btnSubmitRequest.FlatStyle = 'Flat'
    $btnSubmitRequest.BackColor = $script:DR_Theme.BtnBlue
    $btnSubmitRequest.ForeColor = $script:DR_Theme.TextDark
    $btnSubmitRequest.Font = $fontBtn
    $btnSubmitRequest.FlatAppearance.BorderSize = 2
    $btnSubmitRequest.FlatAppearance.BorderColor = $script:DR_Theme.Border
    $btnSubmitRequest.Add_Click({
        $request = $txtRequest.Text.Trim()
        if (-not [string]::IsNullOrWhiteSpace($request) -and $request -ne "Enter feature requests here...`r`n`r`nExamples:`r`n- Add DNS flush tool`r`n- Add port scanner`r`n- Add bandwidth test") {
            _MsgInfo "Feature request logged:`r`n`r`n$request`r`n`r`nThank you for your feedback!"
            & $script:DR_Status "Feature request submitted"
            $txtRequest.Text = "Enter feature requests here...`r`n`r`nExamples:`r`n- Add DNS flush tool`r`n- Add port scanner`r`n- Add bandwidth test"
        } else {
            _MsgErr "Please enter a valid feature request."
        }
    })
    [void]$RequestTLP.Controls.Add($btnSubmitRequest, 0, 2)

    [void]$ContentSplit.Controls.Add($RequestPanel, 1, 0)

    # Define diagnostic tools with Star Trek-style color scheme
    $tools = @(
        @{
            Name = 'PING DIAGNOSTIC'
            Color = $script:DR_Theme.BtnOrange
            Command = 'Test-Connection -ComputerName {TARGET} -Count 10 | Format-Table -AutoSize'
            RequiresTarget = $true
        }
        @{
            Name = 'DNS LOOKUP'
            Color = $script:DR_Theme.BtnBlue
            Command = 'Resolve-DnsName -Name {TARGET} | Format-List'
            RequiresTarget = $true
        }
        @{
            Name = 'TRACEROUTE'
            Color = $script:DR_Theme.BtnPurple
            Command = 'Test-NetConnection -ComputerName {TARGET} -TraceRoute | Format-List'
            RequiresTarget = $true
        }
        @{
            Name = 'SERVICE STATUS'
            Color = $script:DR_Theme.BtnGreen
            Command = 'Get-Service -ComputerName {TARGET} | Where-Object { $_.StartType -ne ''Disabled'' } | Sort-Object Status, Name | Format-Table -AutoSize | Out-String -Width 200'
            RequiresTarget = $true
        }
        @{
            Name = 'DISK SPACE'
            Color = $script:DR_Theme.BtnYellow
            Command = 'if (''{TARGET}'' -eq ''localhost'') { Get-PSDrive -PSProvider FileSystem | Where-Object { $_.Used -ne $null } | Select-Object Name, @{n=''Used(GB)'';e={[math]::Round($_.Used/1GB,2)}}, @{n=''Free(GB)'';e={[math]::Round($_.Free/1GB,2)}}, @{n=''Total(GB)'';e={[math]::Round(($_.Used+$_.Free)/1GB,2)}} | Format-Table -AutoSize } else { Get-WmiObject Win32_LogicalDisk -ComputerName {TARGET} -Filter "DriveType=3" | Select-Object DeviceID, @{n=''Used(GB)'';e={[math]::Round(($_.Size-$_.FreeSpace)/1GB,2)}}, @{n=''Free(GB)'';e={[math]::Round($_.FreeSpace/1GB,2)}}, @{n=''Total(GB)'';e={[math]::Round($_.Size/1GB,2)}} | Format-Table -AutoSize }'
            RequiresTarget = $true
        }
        @{
            Name = 'CPU & MEMORY'
            Color = $script:DR_Theme.BtnTeal
            Command = '$cs = Get-WmiObject Win32_ComputerSystem -ComputerName {TARGET}; $os = Get-WmiObject Win32_OperatingSystem -ComputerName {TARGET}; $cpu = Get-WmiObject Win32_Processor -ComputerName {TARGET}; Write-Host "CPU: $($cpu.Name)"; Write-Host "Cores: $($cpu.NumberOfCores)"; Write-Host "Total RAM: $([math]::Round($cs.TotalPhysicalMemory/1GB,2)) GB"; Write-Host "Free RAM: $([math]::Round($os.FreePhysicalMemory/1MB/1024,2)) GB"; Write-Host "Uptime: $((Get-Date) - $os.ConvertToDateTime($os.LastBootUpTime))"'
            RequiresTarget = $true
        }
        @{
            Name = 'UPTIME CHECK'
            Color = $script:DR_Theme.BtnRed
            Command = '$os = Get-WmiObject Win32_OperatingSystem -ComputerName {TARGET}; $lastBoot = $os.ConvertToDateTime($os.LastBootUpTime); $uptime = (Get-Date) - $lastBoot; Write-Host "Computer: {TARGET}"; Write-Host "OS: $($os.Caption)"; Write-Host "Last Boot: $($lastBoot.ToString(''yyyy-MM-dd HH:mm:ss''))"; Write-Host "Uptime: $($uptime.Days) days, $($uptime.Hours) hours, $($uptime.Minutes) minutes"'
            RequiresTarget = $true
        }
        @{
            Name = 'CERTIFICATE CHECK'
            Color = $script:DR_Theme.BtnPurple
            Command = 'Get-ChildItem Cert:\LocalMachine\My | Where-Object { $_.HasPrivateKey } | Select-Object Subject, Issuer, NotAfter, @{n=''DaysUntilExpiry'';e={($_.NotAfter - (Get-Date)).Days}}, Thumbprint | Format-Table -AutoSize -Wrap'
            RequiresTarget = $false
        }
        @{
            Name = 'NETWORK CONFIG'
            Color = $script:DR_Theme.BtnBlue
            Command = 'Get-NetIPConfiguration | Format-List; Get-NetAdapter | Select-Object Name, Status, LinkSpeed, MacAddress | Format-Table -AutoSize'
            RequiresTarget = $false
        }
    )

    # Create buttons for each tool
    foreach ($tool in $tools) {
        $btn = New-StarTrekButton -Text $tool.Name -BackColor $tool.Color
        $btn.Tag = $tool
        $btn.Add_Click({
            $toolData = $this.Tag
            & $script:DR_Status "Launching: $($toolData.Name)..."
            Invoke-DiagnosticTool -ToolName $toolData.Name -Command $toolData.Command -RequiresTarget $toolData.RequiresTarget
        })
        [void]$ButtonFlow.Controls.Add($btn)
    }

    # Initial status
    & $script:DR_Status "Diagnostics and Repair ready - select a tool to begin"

    return $PageRoot
}
