# RunMenu.txt  (TXT-only)
# SomearnTK - Startup Router (SCOPE-FIXED)
#
# Your environment:
# - Modules/Menu/Tools live in: \\lsfile03\netdoc$\Somearns_Folder\SomearnTK_app\appdata
# - Script inventory lives in: \\lsfile03\netdoc$\Somearns_Folder\SomearnTK_app\appscripts
#
# CRITICAL SCOPE RULE:
# - Do NOT dot-source AG_*.txt modules inside a helper function.
#   That traps exported functions inside that function scope.
# - This loader dot-sources modules INLINE at top scope so Show-MenuMain persists.
#
$ErrorActionPreference = 'Stop'
$WarningPreference     = 'SilentlyContinue'
$ProgressPreference    = 'SilentlyContinue'

Add-Type -AssemblyName System.Windows.Forms | Out-Null
Add-Type -AssemblyName System.Drawing       | Out-Null
[System.Windows.Forms.Application]::EnableVisualStyles()

function _MsgErr([string]$t){ [System.Windows.Forms.MessageBox]::Show($t,'SomearnTK','OK','Error') | Out-Null }
function _MsgInfo([string]$t){ [System.Windows.Forms.MessageBox]::Show($t,'SomearnTK','OK','Information') | Out-Null }

# ---- Hard paths ----
$script:AG_AppDataPath    = '\\lsfile03\netdoc$\Somearns_Folder\SomearnTK_app\appdata'
$script:AG_AppScriptsPath = '\\lsfile03\netdoc$\Somearns_Folder\SomearnTK_app\appscripts'

if (-not (Test-Path -LiteralPath $script:AG_AppDataPath)) {
    _MsgErr "Startup failed:`r`nAppData path not found:`r`n$script:AG_AppDataPath"
    return
}

# In your toolkit, AgScriptsFolder is used as the module root (appdata)
$script:AgScriptsFolder = $script:AG_AppDataPath

# Expose appscripts inventory path for tools like Script Launcher (listing only)
$script:AG_ScriptsInventoryPath = $script:AG_AppScriptsPath

# Snapshot functions BEFORE loading MenuMain (diagnostic only)
$__beforeFns = @()
try { $__beforeFns = (Get-Command -CommandType Function -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Name) } catch { $__beforeFns = @() }

# --- Optional: Themes ---
try {
    $themePath = Join-Path $script:AG_AppDataPath 'AG_Themes.txt'
    if (Test-Path -LiteralPath $themePath) {
        $themeCode = Get-Content -LiteralPath $themePath -Raw
        . ([scriptblock]::Create($themeCode))
    }
} catch {
    _MsgErr ("Theme load failed:`r`n{0}`r`n`r`n{1}" -f $themePath, $_.Exception.Message)
    return
}

# --- Required: MenuMain (INLINE dot-source to preserve Show-MenuMain) ---
$menuPath = Join-Path $script:AG_AppDataPath 'AG_MenuMain.txt'
if (-not (Test-Path -LiteralPath $menuPath)) {
    _MsgErr "Startup failed:`r`nMissing module file:`r`n$menuPath"
    return
}

try {
    $menuCode = Get-Content -LiteralPath $menuPath -Raw
} catch {
    _MsgErr ("Startup failed reading:`r`n{0}`r`n`r`n{1}" -f $menuPath, $_.Exception.Message)
    return
}

try {
    # THIS is the fix: dot-source at top scope, not inside a helper function.
    . ([scriptblock]::Create($menuCode))
} catch {
    _MsgErr ("Startup failed loading:`r`n{0}`r`n`r`n{1}" -f $menuPath, $_.Exception.Message)
    return
}

# Snapshot functions AFTER loading MenuMain (diagnostic only)
$__afterFns = @()
try { $__afterFns = (Get-Command -CommandType Function -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Name) } catch { $__afterFns = @() }

# Identify what AG_MenuMain actually added
$__added = @()
try {
    $setBefore = New-Object 'System.Collections.Generic.HashSet[string]' ([StringComparer]::OrdinalIgnoreCase)
    foreach ($b in $__beforeFns) { [void]$setBefore.Add($b) }
    foreach ($a in $__afterFns)  { if (-not $setBefore.Contains($a)) { $__added += $a } }
} catch { $__added = @() }

# Entrypoint check (try both common names)
$cmd = Get-Command -Name 'Show-MenuMain' -ErrorAction SilentlyContinue
if (-not $cmd) { $cmd = Get-Command -Name 'Show-Menu' -ErrorAction SilentlyContinue }

if (-not $cmd) {
    # Diagnostics (kept short but actionable)
    $fi = $null
    try { $fi = Get-Item -LiteralPath $menuPath -ErrorAction Stop } catch {}
    $meta = if ($fi) {
        "Path:`r`n$menuPath`r`n`r`nSize:`r`n$($fi.Length) bytes`r`n`r`nLastWrite:`r`n$($fi.LastWriteTime)"
    } else {
        "Path:`r`n$menuPath"
    }

    $addedPreview = if ($__added -and $__added.Count -gt 0) { ($__added | Sort-Object | Select-Object -First 25) -join ', ' } else { '(none)' }

    _MsgErr ("Startup failed:`r`nAG_MenuMain.txt loaded, but no Show-MenuMain entrypoint was found.`r`n`r`n{0}`r`n`r`nNew functions added by AG_MenuMain load (top 25):`r`n{1}" -f $meta, $addedPreview)
    return
}

# Launch menu
try {
    & $cmd.Name
} catch {
    _MsgErr ("Menu crashed:`r`n{0}" -f $_.Exception.Message)
}
